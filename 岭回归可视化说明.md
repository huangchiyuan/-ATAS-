# 岭回归可视化功能说明

## ✅ 新增功能

### 1. Ridge 模型可视化

✅ **双重 Spread 曲线对比**
- **黄色曲线**：Kalman 滤波的 Spread 值
- **青色曲线**：Ridge 回归的 Spread 值
- 两条曲线同时显示，便于对比两个模型的信号差异

✅ **Ridge 状态灯**
- 新增 "Ridge Spread" 状态灯
- 显示 Ridge 模型的信号状态（做多/做空/中性）
- 与 Kalman 状态灯并排显示，便于对比

---

### 2. Ridge 参数实时调整

✅ **Ridge Lambda（遗忘因子）**
- **控件位置**：参数调整面板第 3 行
- **范围**：0.99 - 0.999
- **默认值**：0.995
- **作用**：控制模型对历史数据的记忆长度
  - 值越大（接近 0.999）：记忆越长，更稳定
  - 值越小（接近 0.99）：记忆越短，更灵敏
- **实时生效**：参数修改后立即在下次更新时生效

✅ **Ridge Alpha（惩罚系数）**
- **控件位置**：参数调整面板第 3 行
- **范围**：1e-5 - 1e-2
- **默认值**：1e-4
- **作用**：控制模型的正则化强度（这是产生 Spread 的核心参数）
  - 值越大（如 1e-3）：更强的惩罚，Spread 更大但可能滞后
  - 值越小（如 1e-5）：更弱的惩罚，Spread 更小但响应更快
- **实时生效**：参数修改后立即在下次更新时生效

---

## 📊 界面变化

### 状态灯区域

原来有 4 个状态灯：
- Model Spread
- OBI Flow
- Iceberg
- BTC Risk

现在有 5 个状态灯：
- **Kalman Spread**（原 Model Spread）
- **Ridge Spread**（新增）
- OBI Flow
- Iceberg
- BTC Risk

### 图表区域

原来显示 1 条曲线：
- 黄色曲线：Kalman Spread

现在显示 2 条曲线：
- **黄色曲线**：Kalman Spread
- **青色曲线**：Ridge Spread

图表左侧会显示图例，说明两条曲线的含义。

### 参数调整面板

原来有 4 个参数：
- Spread 阈值
- Kalman R
- OBI 阈值
- Kalman Q Beta

现在有 6 个参数（分 3 行）：
- **第 1 行**：Spread 阈值、Kalman R
- **第 2 行**：OBI 阈值、Kalman Q Beta
- **第 3 行**：**Ridge Lambda**、**Ridge Alpha**（新增）

---

## 🔍 使用场景

### 场景 1：模型对比

**目的**：观察 Kalman 和 Ridge 两个模型的信号差异

**操作**：
1. 查看图表中的两条曲线
2. 如果两条曲线走势一致 → 信号可靠，两个模型都同意
3. 如果两条曲线差异很大 → 需要检查参数设置或市场状态

---

### 场景 2：参数调优

**目的**：调整 Ridge 参数，使其信号更符合预期

**操作**：
1. 观察青色曲线（Ridge Spread）的波动
2. 如果信号太少 → 减小 Ridge Alpha 或增大 Ridge Lambda
3. 如果信号太多（噪音大）→ 增大 Ridge Alpha 或减小 Ridge Lambda
4. 如果信号滞后 → 减小 Ridge Lambda（记忆更短，响应更快）

---

### 场景 3：双重确认

**目的**：只有当两个模型都给出相同信号时，才执行交易

**操作**：
1. 观察两个状态灯的颜色
2. 如果两个都是绿色（做多）或都是红色（做空）→ 信号一致
3. 如果颜色不一致 → 信号分歧，需要谨慎
4. 可以结合顶部指令区，只有当双重确认时才执行

---

## ⚙️ 参数调优建议

### Ridge Lambda（遗忘因子）

**范围**：0.99 - 0.999

| 值 | 记忆长度 | 特点 | 适用场景 |
|----|---------|------|---------|
| 0.99 | ~100 tick | 快速响应 | 波动大的市场 |
| 0.995 | ~200 tick | 平衡（默认） | 正常市场 |
| 0.999 | ~1000 tick | 非常稳定 | 趋势明显的市场 |

**调优建议**：
- 如果 Ridge 曲线滞后 → **减小** Lambda（如 0.992）
- 如果 Ridge 曲线乱跳 → **增大** Lambda（如 0.998）

---

### Ridge Alpha（惩罚系数）

**范围**：1e-5 - 1e-2

| 值 | 特点 | Spread 大小 | 适用场景 |
|----|------|------------|---------|
| 1e-5 | 弱惩罚 | 小 | 薄市场，需要快速响应 |
| 1e-4 | 标准惩罚（默认） | 中等 | 正常市场 |
| 1e-3 | 强惩罚 | 大 | 厚市场，需要更可靠的信号 |

**调优建议**：
- 如果 Spread 一直为 0 → **增大** Alpha（如 1e-3）
- 如果 Spread 太大，信号滞后 → **减小** Alpha（如 1e-5）

---

## 💡 关键理解

### 为什么需要两个模型？

1. **双重验证**：两个模型都同意时，信号更可靠
2. **互补性**：
   - Kalman：基于状态空间模型，适合动态系统
   - Ridge：基于正则化回归，抗共线性，强制保留 Spread
3. **对比学习**：通过对比两个模型的差异，更好地理解市场

### Ridge 模型的优势

1. **抗共线性**：NQ 和 YM 高度相关时，Ridge 更稳定
2. **强制 Spread**：通过 L2 惩罚，防止过度拟合，保留交易信号
3. **参数稳定**：Beta 参数不会像 Kalman 那样频繁跳动

---

## 📝 技术细节

### 数据处理

- Ridge 模型与 Kalman 模型**独立运行**
- 两者接收相同的 Tick 数据
- 两者使用相同的基准价格归一化
- 两者分别计算自己的 Fair Price 和 Spread

### 参数更新

- Ridge 参数修改后，会在**下次 update() 调用时生效**
- Lambda 和 Alpha 都通过 `self.cfg` 访问，修改配置即可
- 不需要重启模型，但需要等待新数据到来

### 性能

- Ridge 模型的计算成本很低，几乎不影响性能
- 两条曲线的绘制由 PyQtGraph 优化，性能良好

---

## 🔗 相关文档

- **仪表盘使用说明**：`仪表盘使用说明.md`
- **Ridge 模型说明**：`norden_v3/ridge_model.py`
- **配置参数说明**：`norden_v3/配置参数说明.md`

---

**最后更新**：2025-01-19  
**版本**：v1.1（新增 Ridge 可视化）

