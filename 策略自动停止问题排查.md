# 策略自动停止问题排查指南

## 问题描述

策略自动全部停掉了，但 ATAS 数据都还在发送。

## 可能原因

### 1. **默认运行时长限制（已修复）**

**问题**：之前的版本默认运行 60 秒后自动退出。

**解决方案**：
- ✅ 已修改为持续运行（`duration_seconds=None`）
- 按 `Ctrl+C` 手动停止回测
- 如需限制时长，可在代码中设置，例如：`duration_seconds=300.0` (5分钟)

### 2. **程序异常崩溃**

**问题**：未捕获的异常导致程序退出。

**解决方案**：
- ✅ 已添加完整的异常捕获机制
- ✅ 所有事件处理函数都有 try-catch 保护
- ✅ 异常会被打印但不会导致程序退出

### 3. **UDP 监听器停止**

**问题**：UDP 监听线程异常退出，导致无法接收数据。

**解决方案**：
- ✅ 已添加监听器状态监控
- ✅ 每 5 秒检查监听器是否存活
- ✅ 如果监听器停止，会显示警告信息

## 修复内容

### 1. 持续运行模式

```python
# 之前：默认 60 秒后退出
suite.run(duration_seconds=60.0)

# 现在：持续运行直到手动中断
suite.run(duration_seconds=None)
```

### 2. 完善的错误处理

- 事件处理异常捕获
- 策略引擎异常捕获
- 分析器异常捕获
- 所有异常都会打印堆栈但不会导致程序退出

### 3. 诊断信息增强

统计输出现在包括：
- 运行时长
- UDP 监听器状态（✅/❌）
- 事件处理速度
- 队列大小
- 数据包总数
- 信号数量

示例输出：
```
[STATS] 运行时长: 120s | ✅监听器 | 事件: 1523/s | 信号: 45 | 队列: 12 | 数据包: 182,456
```

### 4. 监听器状态监控

- 启动时检查监听器是否成功启动
- 运行时持续监控监听器状态
- 如果监听器停止，立即显示警告

## 使用方法

### 运行并行回测

```bash
python run_backtest_suite_parallel.py
```

### 手动停止

按 `Ctrl+C` 手动停止回测。程序会：
1. 停止接收新数据
2. 保存所有详细报告
3. 生成对比报告
4. 安全退出

### 设置运行时长（可选）

如果需要限制运行时长，可以修改代码：

```python
# 运行 5 分钟
suite.run(duration_seconds=300.0)

# 运行 1 小时
suite.run(duration_seconds=3600.0)
```

## 诊断步骤

如果策略仍然自动停止，请按以下步骤排查：

### 步骤 1：查看控制台输出

检查是否有以下信息：
- `⏰ 已达到运行时长限制` - 说明达到时长限制
- `⚠️ [ERROR]` - 说明有异常发生
- `⚠️ [WARNING] UDP 监听器线程已停止` - 说明监听器停止

### 步骤 2：检查 UDP 监听器状态

在统计输出中查看：
- `✅监听器` - 监听器正常运行
- `❌监听器` - 监听器已停止

如果显示 `❌监听器`，说明 UDP 端口可能有问题。

### 步骤 3：检查数据接收

查看统计输出：
- `事件: 0/s` - 没有接收到事件
- `数据包: 0` - UDP 监听器没有收到数据包
- `队列: 0` - 队列为空

如果长时间没有数据，可能是：
1. ATAS 数据源停止发送
2. UDP 端口被占用
3. 网络问题

### 步骤 4：检查异常日志

如果看到 `⚠️ [ERROR]` 信息，查看完整的错误堆栈，定位问题。

## 常见问题

### Q: 为什么队列一直是空的？

**A**: 可能原因：
1. ATAS 数据源没有发送数据
2. UDP 端口被其他程序占用
3. 网络配置问题

**解决方案**：
1. 检查 ATAS 是否在发送数据
2. 检查端口 5555 是否被占用
3. 尝试重启程序

### Q: 为什么监听器显示已停止？

**A**: UDP 监听线程异常退出。

**可能原因**：
1. 端口被占用
2. 网络错误
3. 系统资源不足

**解决方案**：
1. 检查端口占用情况：`netstat -ano | findstr 5555`
2. 关闭其他占用端口的程序
3. 重启程序

### Q: 程序运行一段时间后没有新信号？

**A**: 这可能是正常的，取决于：
1. 市场条件
2. 策略参数设置
3. 过滤条件

**检查方法**：
- 查看统计输出中的 `事件` 速度
- 如果事件速度正常，说明数据正常，只是没有触发信号
- 如果事件速度为 0，说明数据接收有问题

## 技术细节

### 异常处理层次

1. **事件处理层**：捕获单个事件处理异常
2. **策略引擎层**：捕获每个配置的引擎异常
3. **主循环层**：捕获所有未预期的异常

### 监听器监控

- 使用 `threading.Thread.is_alive()` 检查线程状态
- 每 5 秒检查一次
- 如果停止，显示警告但不退出程序（数据仍会处理队列中的事件）

### 队列保护

- 队列最大容量：100,000 条
- 如果队列满，新事件会被丢弃（避免阻塞）
- 统计输出显示队列大小，帮助诊断

## 联系支持

如果问题仍然无法解决，请提供：
1. 完整的控制台输出
2. 错误信息（如果有）
3. 运行时长
4. 统计输出的最后几行

---

**最后更新**：2025-01-19

