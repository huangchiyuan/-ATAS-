# 回测系统信号诊断说明

## 🔍 问题：没有信号产生

如果没有信号产生，可能的原因有：

### 1. 参数设置问题

归一化后的参数可能导致 Spread 太小：

- **r_obs = 1.0**（归一化后）可能导致 Spread 太小
- **threshold = 0.5 tick** 相对于小的 Spread 来说可能太高

### 2. 数据接收问题

- NQ 数据缺失：策略需要 NQ 数据才能工作
- DOM 数据缺失：策略需要 DOM 数据才能下单

### 3. 过滤器太严格

- OBI 过滤：`min_obi_for_long = 0.1` 可能太严格
- BTC 风险过滤：可能一直触发熔断
- 队列过滤：队列长度可能一直超过阈值

---

## ✅ 诊断步骤

### 步骤 1：检查数据接收

运行回测时，观察控制台输出：
- `[STATS]` 行会显示事件处理速度
- `[DEBUG]` 行会显示数据接收状态

如果看到：
```
[DEBUG] ES=True NQ=False DOM=False
```
说明 NQ 或 DOM 数据没有接收。

### 步骤 2：调整参数

如果数据接收正常但没有信号，尝试：

1. **降低 Spread 阈值**：
   ```python
   base_spread_threshold=0.3  # 从 0.5 降低到 0.3
   ```

2. **降低 OBI 阈值**：
   ```python
   min_obi_for_long=0.05  # 从 0.1 降低到 0.05
   ```

3. **增大 Kalman R**：
   ```python
   r_obs=2.0  # 从 1.0 增大到 2.0，产生更大的 Spread
   ```

### 步骤 3：检查过滤器

如果策略有信号但被过滤，检查：

1. **BTC 风险过滤**：
   - 如果 BTC 一直触发熔断，可能是波动率阈值太敏感

2. **OBI 过滤**：
   - 如果 OBI 一直不满足条件，可能是阈值太高

3. **队列过滤**：
   - 如果队列长度一直超过阈值，可能需要增大 `max_queue_size`

---

## 🔧 快速修复建议

### 方案 1：放宽参数（快速测试）

```python
self.engine = NordenMakerV3(
    maker_cfg=MakerConfig(
        base_spread_threshold=0.3,  # 降低阈值
        min_obi_for_long=0.05,      # 降低 OBI 要求
        max_queue_size=500,         # 增大队列限制
    ),
    kalman_cfg=KalmanConfig(r_obs=2.0, q_beta=1e-8),  # 增大 R
)
```

### 方案 2：禁用部分过滤器（调试用）

可以临时注释掉某些过滤器，看是否能产生信号。

---

## 📊 诊断输出说明

运行回测时，注意观察：

1. **`[STATS]` 行**：
   - 事件速度：应该 > 0
   - 信号速度：如果有信号，应该 > 0

2. **`[DEBUG]` 行**：
   - ES/NQ/DOM：都应该为 True
   - Fair/Spread：应该有数值

3. **`[SIGNAL]` 行**：
   - 如果有信号，会显示信号详情

---

**最后更新**：2025-01-19

