# 项目 Python 文件说明

本文档详细说明量化交易系统中使用的所有 Python 文件及其功能。

---

## 一、Norden Engine v3.1 核心模块

**位置**：`norden_v3/` 目录

### 1.1 核心引擎

| 文件 | 功能说明 |
|------|---------|
| `__init__.py` | 模块初始化，导出所有核心类和配置 |
| `types.py` | 标准数据类型定义（TickEvent, DomSnapshot, OrderCommand, Side, OrderType） |
| `maker_engine.py` | **策略主引擎**：`NordenMakerV3` 类，实现完整的交易决策流程 |

### 1.2 定价模型

| 文件 | 功能说明 |
|------|---------|
| `kalman_model.py` | **在线卡尔曼滤波器**：实时估计 ES 公允价（基于 NQ/YM 相关性） |
| `ridge_model.py` | **在线岭回归模型**：备用定价模型，与 Kalman 并行计算 |

### 1.3 微观因子

| 文件 | 功能说明 |
|------|---------|
| `obi_calculator.py` | **加权订单簿失衡度 (Weighted OBI)**：计算订单簿买卖失衡程度 |
| `iceberg_detector.py` | **冰山订单检测器**：通过成交量/挂单量差异识别隐藏订单 |
| `btc_regime.py` | **BTC 风险监控**：检测极端市场波动，触发熔断保护 |

---

## 二、数据接收与处理

| 文件 | 功能说明 |
|------|---------|
| `dom_data_feed.py` | **UDP 数据监听器**：从 C# ATAS 平台接收实时市场数据（Tick/DOM）<br>- `UdpListener`：UDP 服务器，接收并解析数据<br>- `InstrumentState`：维护单个合约的状态（价格、DOM、成交记录） |

---

## 三、测试与运行脚本

### 3.1 Norden Engine v3.1 测试脚本

| 文件 | 功能说明 |
|------|---------|
| `run_norden_v3_test.py` | **完整系统测试脚本**：<br>- 接收 UDP 数据<br>- 运行 Kalman/Ridge 定价模型<br>- 计算 OBI、冰山检测、BTC 风险监控<br>- 显示完整的策略决策流程<br>- **输出格式**：实时状态 + 交易信号（不下单） |

### 3.2 Kalman 模型测试脚本

| 文件 | 功能说明 |
|------|---------|
| `test_udp_feed.py` | UDP 数据接收测试（最简版，打印原始数据） |
| `run_kalman_live.py` | Kalman 模型实时运行，控制台输出（ES, Fair, Spread, Beta） |
| `run_kalman_viz.py` | Matplotlib 可视化（旧版，已弃用） |
| `run_kalman_qt.py` | **PyQtGraph 高性能可视化**：<br>- 实时绘制 ES/NQ/YM 价格<br>- Kalman/Ridge 公允价<br>- 使用 Baseline Indexing 归一化<br>- 支持缩放、平移交互 |

---

## 四、可视化与 GUI

### 4.1 主程序

| 文件 | 功能说明 |
|------|---------|
| `pyqt_dom_viewer.py` | **PyQt DOM 查看器（NFQE Lite）**：<br>- 实时显示订单簿（DOM）<br>- K 线图、Volume Profile<br>- P0 指标计算（ValueLine, SweepRadar, Trinity, SmartExecution）<br>- 综合交易界面 |
| `live_dom_viewer.py` | **Tkinter DOM 查看器**：轻量级实时订单簿查看器 |

### 4.2 可视化组件（widgets/）

| 文件 | 功能说明 |
|------|---------|
| `__init__.py` | 组件模块初始化 |
| `dom_table.py` | DOM 表格组件：显示订单簿层级数据 |
| `kline_widget.py` | K 线图组件：绘制价格和成交量 |
| `metrics_widgets.py` | 指标组件：显示各种技术指标 |
| `vp_widget.py` | Volume Profile 组件：显示成交量分布 |

---

## 五、分析模块（modules/）

| 文件 | 功能说明 |
|------|---------|
| `value_line.py` | **价值线计算器**：计算 POC（Point of Control）、VAH/VAL |
| `sweep_radar.py` | **扫单雷达**：检测大单扫盘行为 |
| `trinity.py` | **三要素评分**：综合价格、成交量、时间维度评分 |
| `smart_exec.py` | **智能执行**：订单执行优化算法 |
| `risk_control.py` | 风险控制模块（旧版，已部分整合到 v3.1） |

---

## 六、数据存储与读取

| 文件 | 功能说明 |
|------|---------|
| `data_recorder_async_pandas.py` | 异步数据记录器：将市场数据存储到 DuckDB |
| `data_reader.py` | 数据读取器：从 DuckDB 读取历史数据 |
| `check_data.py` | 数据检查工具：验证数据完整性 |
| `db_checker.py` | 数据库检查工具 |
| `db_gap_detector.py` | 数据库缺口检测器：检测数据缺失时段 |

---

## 七、回测与分析工具

| 文件 | 功能说明 |
|------|---------|
| `nfqe_main.py` | NFQE 主程序（旧版策略引擎） |
| `nfqe_backtest_viz.py` | 回测可视化工具 |
| `nfqe_diagnostic.py` | 诊断工具：分析策略表现 |

---

## 八、其他工具

| 文件 | 功能说明 |
|------|---------|
| `NordenEngine.py` | Norden 引擎（旧版，已被 v3.1 替代） |
| `dynamic_params.py` | 动态参数管理 |
| `voice_checklist.py` | 语音检查清单工具 |
| `demo.py` | 演示脚本 |

---

## 九、文件依赖关系

### 9.1 Norden Engine v3.1 模块依赖

```
norden_v3/
├── types.py (基础类型)
├── kalman_model.py (定价模型)
├── ridge_model.py (定价模型)
├── obi_calculator.py (微观因子)
├── iceberg_detector.py (防御因子)
├── btc_regime.py (风控)
└── maker_engine.py (主引擎，依赖上述所有模块)
```

### 9.2 测试脚本依赖

```
run_norden_v3_test.py
├── dom_data_feed.py (数据接收)
└── norden_v3/ (所有核心模块)
```

### 9.3 GUI 程序依赖

```
pyqt_dom_viewer.py
├── dom_data_feed.py (数据接收)
├── widgets/ (可视化组件)
└── modules/ (分析模块)
```

---

## 十、核心工作流程

### 10.1 Norden Engine v3.1 运行流程

```
1. 数据接收 (dom_data_feed.py)
   ↓
2. 事件转换 (TickEvent, DomSnapshot)
   ↓
3. 定价模型 (kalman_model.py, ridge_model.py)
   ↓
4. 微观因子 (obi_calculator.py)
   ↓
5. 防御因子 (iceberg_detector.py)
   ↓
6. 风控检查 (btc_regime.py)
   ↓
7. 策略决策 (maker_engine.py)
   ↓
8. 订单输出 (OrderCommand)
```

### 10.2 数据流向

```
C# ATAS 平台
  ↓ (UDP)
dom_data_feed.py (UdpListener)
  ↓ (事件队列)
策略引擎/可视化程序
  ↓
DuckDB 存储 (可选)
```

---

## 十一、文件使用建议

### 11.1 新用户入门

1. **测试数据接收**：`test_udp_feed.py`
2. **测试定价模型**：`run_kalman_live.py`
3. **完整系统测试**：`run_norden_v3_test.py`
4. **可视化分析**：`run_kalman_qt.py`

### 11.2 开发调试

1. **模块单元测试**：直接运行各模块文件
2. **集成测试**：`run_norden_v3_test.py`
3. **数据检查**：`check_data.py`, `db_checker.py`

### 11.3 生产环境

1. **策略运行**：`run_norden_v3_test.py`（或自定义封装）
2. **数据记录**：`data_recorder_async_pandas.py`
3. **可视化监控**：`pyqt_dom_viewer.py` 或 `run_kalman_qt.py`

---

## 十二、总结

### 12.1 核心文件（必须）

| 类别 | 文件 |
|------|------|
| **策略核心** | `norden_v3/` 目录下所有 `.py` 文件（7个文件） |
| **数据接收** | `dom_data_feed.py` |
| **测试运行** | `run_norden_v3_test.py` |

### 12.2 可视化文件（可选）

- `run_kalman_qt.py`：实时可视化
- `pyqt_dom_viewer.py`：完整 GUI
- `widgets/` 目录：可视化组件

### 12.3 工具文件（辅助）

- 数据存储/读取：`data_*.py`, `db_*.py`
- 分析模块：`modules/*.py`
- 回测工具：`nfqe_*.py`

---

**最后更新**：2025-01-19  
**项目版本**：Norden Engine v3.1

