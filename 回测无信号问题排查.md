# 回测无信号问题排查指南

## 🔍 可能的原因

如果回测时完全没有信号，可能的原因包括：

### 1. 数据接收问题

- **NQ 数据缺失**：策略引擎需要 NQ 数据才能计算 Fair Price 和 Spread
- **DOM 数据缺失**：策略需要 DOM 数据才能下单（需要最佳买卖价）

### 2. 参数设置问题

- **Spread 阈值太高**：`base_spread_threshold=0.5` 可能相对于实际的 Spread 来说太高
- **Kalman R 太小**：归一化后的 `r_obs=1.0` 可能导致 Spread 太小，无法触发信号
- **过滤器太严格**：OBI、BTC、队列等过滤器可能全部拒绝信号

### 3. 策略逻辑问题

- **模型未收敛**：Kalman 模型可能需要一定时间才能收敛
- **数据不同步**：ES/NQ/YM 数据可能不同步，导致模型无法正常工作

---

## ✅ 诊断步骤

### 步骤 1：检查数据接收

运行回测时，观察控制台输出：

```
[STATS] 事件: 1234/s | 信号: 0.00/s | ...
[DEBUG] 事件=5000 | ES=6866.75 NQ=21000.5 DOM=✓ | Fair=6866.80 Spread=+0.20t | 信号数=0
```

**检查点**：
- ✅ ES 价格是否有数值
- ✅ NQ 价格是否有数值（必须！）
- ✅ DOM 是否有数据（必须！）
- ✅ Fair Price 是否有数值
- ✅ Spread 是否有数值

### 步骤 2：检查 Spread 大小

如果 Spread 一直很小（< 0.3 tick），说明：
- Kalman R 可能太小，需要增大
- 或者模型过度拟合，Spread 被"吃掉"

**解决方案**：
- 增大 `r_obs` 到 3.0-5.0
- 或降低 `base_spread_threshold` 到 0.25

### 步骤 3：检查过滤器

如果数据正常但没信号，可能是过滤器太严格：

1. **OBI 过滤**：检查 OBI 是否满足条件
2. **BTC 风险过滤**：检查是否一直触发熔断
3. **队列过滤**：检查队列长度是否一直超过阈值

---

## 🔧 快速修复方案

### 方案 1：使用测试脚本的参数（推荐）

```python
self.engine = NordenMakerV3(
    maker_cfg=MakerConfig(
        base_spread_threshold=0.5,  # 恢复原值
        min_obi_for_long=0.1,
        max_queue_size=300,
    ),
    kalman_cfg=None,  # 使用默认配置（和测试脚本一致）
    order_sink=self._on_strategy_order,
)
```

### 方案 2：进一步放宽参数（如果方案 1 不行）

```python
self.engine = NordenMakerV3(
    maker_cfg=MakerConfig(
        base_spread_threshold=0.25,  # 进一步降低
        min_obi_for_long=0.0,        # 取消 OBI 限制
        max_queue_size=1000,         # 大幅增大队列限制
    ),
    kalman_cfg=KalmanConfig(r_obs=5.0, q_beta=1e-8),  # 大幅增大 R
    order_sink=self._on_strategy_order,
)
```

---

## 📊 调试输出说明

运行回测时，观察以下输出：

1. **`[STATS]`**：显示处理速度和信号数量
2. **`[DEBUG]`**：显示数据接收状态和策略状态
3. **`[SIGNAL]`**：如果有信号，会显示信号详情

---

**最后更新**：2025-01-19

