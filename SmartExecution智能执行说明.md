# Smart Execution（智能执行）使用说明

## 一、功能概述

**Smart Execution（智能执行）**是一个智能挂单推荐系统，根据市场Tape速度（成交量速度）动态调整挂单距离，帮助交易者在不同市场环境下选择最优的挂单价格。

### 核心原理
- **Tape速度**：监控最近5秒的成交量速度（成交量/秒），反映市场活跃程度
- **动态挂单距离**：根据Tape速度自动调整挂单距离，市场越快，挂单距离越远
- **价值线参考**：结合价值线，判断当前价格是折价还是溢价，决定挂单方向

---

## 二、工作原理

### 2.1 Tape速度计算

**监控窗口**：最近5秒的ES成交数据

**计算公式**：
```
Tape速度 = 总成交量 / 时间窗口（秒）
```

**速度分级**：
- **慢速市场**：< 60 成交量/秒
- **中速市场**：60-180 成交量/秒
- **快速市场**：> 180 成交量/秒

### 2.2 挂单距离计算

根据Tape速度动态调整挂单距离：

| Tape速度 | 市场状态 | 挂单距离（tick） | 说明 |
|---------|---------|----------------|------|
| < 60 | 慢速 | 0.25 - 0.75 | 市场不活跃，挂单可以靠近当前价 |
| 60-180 | 中速 | 0.75 - 1.5 | 市场中等活跃，挂单距离适中 |
| > 180 | 快速 | 1.5 - 3.5 | 市场非常活跃，挂单需要更远，避免被快速扫掉 |

### 2.3 推荐价格计算逻辑

**判断当前价格与价值线的关系**：

1. **当前价格 > 价值线**（溢价）：
   - **推荐买价**：`当前价格 - 挂单距离`（折价买入）
   - **推荐卖价**：`当前价格 + 0.25`（靠近当前价卖出）

2. **当前价格 < 价值线**（折价）：
   - **推荐买价**：`当前价格 - 0.25`（靠近当前价买入）
   - **推荐卖价**：`当前价格 + 挂单距离`（溢价卖出）

**核心思想**：
- 当价格高于价值线时，建议折价买入（等待价格回落）
- 当价格低于价值线时，建议溢价卖出（等待价格回升）

---

## 三、GUI显示

### 3.1 位置
- **指标看板**：左侧上半部分，第4个指标（Smart Execution）

### 3.2 显示内容

#### 价格条（水平条形图）：
- **白色竖线**：当前市场价格位置
- **绿色条**：推荐买价（B:价格）
- **红色条**：推荐卖价（S:价格）

#### 标签信息：
- **Spd: XX**：Tape速度（成交量/秒），显示在左下角
- **B:XX.XX**：推荐买价，显示在绿色条上方
- **S:XX.XX**：推荐卖价，显示在红色条下方

### 3.3 实时更新
- **更新频率**：每次收到ES成交事件时更新
- **Tape速度**：每5秒重新计算
- **推荐价格**：根据最新Tape速度和价格关系重新计算

---

## 四、实际使用场景

### 场景1：慢速市场（Tape速度 < 60）
```
情况：市场不活跃，成交量低
Tape速度：10 成交量/秒
推荐挂单距离：0.25-0.75 tick

操作建议：
- 挂单可以靠近当前价，因为市场不活跃，价格波动小
- 如果当前价格高于价值线，在价值线下方挂买单
- 如果当前价格低于价值线，在价值线上方挂卖单
```

### 场景2：中速市场（Tape速度 60-180）
```
情况：市场中等活跃
Tape速度：100 成交量/秒
推荐挂单距离：0.75-1.5 tick

操作建议：
- 挂单距离适中，平衡成交概率和价格优势
- 根据价值线位置选择挂单方向
```

### 场景3：快速市场（Tape速度 > 180）
```
情况：市场非常活跃，成交量高
Tape速度：300 成交量/秒
推荐挂单距离：1.5-3.5 tick

操作建议：
- 挂单需要更远，避免被快速扫掉
- 快速市场中，价格波动大，需要更大的安全距离
- 如果挂单太近，可能立即成交，失去价格优势
```

### 场景4：价格高于价值线
```
当前价格：6862.00
价值线：6861.11
Tape速度：150 成交量/秒

推荐操作：
- 推荐买价：6861.25（当前价 - 0.75 tick，折价买入）
- 推荐卖价：6862.25（当前价 + 0.25 tick，靠近当前价卖出）

理由：当前价格高于价值线，建议折价买入，等待价格回落
```

### 场景5：价格低于价值线
```
当前价格：6860.50
价值线：6861.11
Tape速度：80 成交量/秒

推荐操作：
- 推荐买价：6860.25（当前价 - 0.25 tick，靠近当前价买入）
- 推荐卖价：6861.25（当前价 + 0.75 tick，溢价卖出）

理由：当前价格低于价值线，建议溢价卖出，等待价格回升
```

---

## 五、与其他指标结合使用

### 5.1 与价值线结合
- **Smart Execution + 价值线**：
  - 价格高于价值线 → 推荐折价买入
  - 价格低于价值线 → 推荐溢价卖出

### 5.2 与三要素评分结合
- **Smart Execution + 三要素评分**：
  - 三要素总分 ≥ 68 + 推荐买价 → 可以挂买单
  - 三要素总分 ≥ 68 + 推荐卖价 → 可以挂卖单
  - 三要素总分 < 68 → 即使有推荐价格也不交易

### 5.3 与扫单雷达结合
- **Smart Execution + 扫单雷达**：
  - STRONG_BUY + 推荐买价 → 强烈做多信号
  - STRONG_SELL + 推荐卖价 → 强烈做空信号

---

## 六、关键参数

### 6.1 Tape速度阈值
- **慢速阈值**：60 成交量/秒
- **中速阈值**：180 成交量/秒
- **快速阈值**：> 180 成交量/秒

### 6.2 挂单距离范围
- **慢速市场**：0.25 - 0.75 tick（1 tick = 0.25点）
- **中速市场**：0.75 - 1.5 tick
- **快速市场**：1.5 - 3.5 tick

### 6.3 时间窗口
- **Tape速度计算窗口**：5秒
- **更新频率**：每次成交事件触发

---

## 七、注意事项

### 7.1 Tape速度的局限性
- **时间窗口**：5秒窗口可能无法完全反映市场状态
- **建议**：结合其他指标（如三要素评分）综合判断

### 7.2 挂单距离的随机性
- **当前实现**：使用`random.uniform()`随机选择距离
- **原因**：避免所有交易者使用相同价格，造成订单聚集
- **建议**：可以根据个人风险偏好调整随机范围

### 7.3 市场异常情况
- **重大事件**：非农、FOMC等可能导致Tape速度异常
- **建议**：重大事件期间谨慎使用，或手动调整挂单距离

### 7.4 价格与价值线的关系
- **当前逻辑**：简单判断价格高于或低于价值线
- **建议**：可以结合价格与价值线的距离，调整挂单距离

---

## 八、代码示例

### 8.1 查看当前推荐价格
```python
# 在主程序中
tape_speed = self.smart_exec.compute_tape_speed()
buy_price, sell_price = self.smart_exec.recommend_price(
    current_price=es_price,
    value_line=value_line,
    params=params
)
print(f"Tape速度: {tape_speed:.1f} 成交量/秒")
print(f"推荐买价: {buy_price:.2f}")
print(f"推荐卖价: {sell_price:.2f}")
```

### 8.2 手动测试
```python
from modules.smart_exec import SmartExecution
import time

# 创建智能执行引擎
exec_engine = SmartExecution()

# 模拟慢速市场
print("=== 慢速市场测试 ===")
for i in range(10):
    exec_engine.update_trade(price=5000.0 + i * 0.25, volume=5)
    time.sleep(0.1)

speed = exec_engine.compute_tape_speed()
buy_p, sell_p = exec_engine.recommend_price(
    current_price=5000.0,
    value_line=5000.5
)
print(f"Tape速度: {speed:.1f} 成交量/秒")
print(f"推荐买价: {buy_p:.2f}, 推荐卖价: {sell_p:.2f}")

# 模拟快速市场
print("\n=== 快速市场测试 ===")
exec_engine = SmartExecution()  # 重置
for i in range(100):
    exec_engine.update_trade(price=5000.0 + i * 0.25, volume=50)
    if i % 20 == 0:
        time.sleep(0.01)

speed = exec_engine.compute_tape_speed()
buy_p, sell_p = exec_engine.recommend_price(
    current_price=5000.0,
    value_line=4999.5
)
print(f"Tape速度: {speed:.1f} 成交量/秒")
print(f"推荐买价: {buy_p:.2f}, 推荐卖价: {sell_p:.2f}")
```

---

## 九、优化建议

### 9.1 挂单距离优化
- **当前问题**：使用随机数，可能不够精确
- **建议**：可以根据历史成交数据，计算最优挂单距离

### 9.2 Tape速度计算优化
- **当前问题**：5秒窗口可能不够准确
- **建议**：可以使用加权平均，最近的数据权重更高

### 9.3 价格与价值线距离
- **当前问题**：只判断高于或低于，不考虑距离
- **建议**：价格与价值线距离越大，挂单距离可以更远

---

## 十、总结

**Smart Execution（智能执行）**是一个实用的挂单推荐系统，通过监控Tape速度，动态调整挂单距离，帮助交易者在不同市场环境下选择最优挂单价格。

### 核心要点：
1. **Tape速度**：反映市场活跃程度，决定挂单距离
2. **价值线参考**：判断价格是折价还是溢价，决定挂单方向
3. **动态调整**：根据市场状态自动调整，无需手动设置
4. **综合使用**：结合三要素评分、扫单雷达等指标，提高交易成功率

### 使用建议：
- **慢速市场**：挂单可以靠近当前价
- **快速市场**：挂单需要更远，避免被快速扫掉
- **价格高于价值线**：建议折价买入
- **价格低于价值线**：建议溢价卖出
- **结合其他指标**：不要单独依赖Smart Execution，结合三要素评分等指标综合判断

**记住**：Smart Execution是辅助工具，不是交易决策的唯一依据。始终做好风险管理，结合多个指标综合判断。

