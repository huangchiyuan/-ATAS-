# 归一化参数调整说明

## ✅ 重要发现

### 模型内部已做基线扣除归一化

模型内部使用了**基线扣除法（Baseline Subtraction）**进行归一化：
- 输入数据从 `[21000, 44000, 6800]` 变成 `[10.5, -5.0, 2.0]`
- 数据量级从**几万**降到了**几十**
- 所有计算都在归一化后的"相对点数"空间进行

### 参数需要相应调整

原来的参数是基于**未归一化**的大数值设计的，归一化后需要调整以匹配新的数据量级。

---

## 📊 归一化前后的对比

### 数据量级变化

| 项目 | 归一化前 | 归一化后 | 变化倍数 |
|------|---------|---------|---------|
| **NQ 输入** | 21000 | +10.5 | ~2000倍 |
| **YM 输入** | 44000 | -5.0 | ~8800倍 |
| **ES 输入** | 6800 | +2.0 | ~3400倍 |
| **误差项** | 可能很大 | -2 ~ +2 点 | 大幅减小 |

### 参数影响

归一化后，参数的作用范围发生了变化：

- **Q（过程噪声）**：输入数据变小，Q 可以适当增大
- **R（观测噪声）**：误差项变小，R 应该大幅减小
- **P（初始协方差）**：Alpha 接近 0，P 可以减小

---

## 🔧 参数调整建议

### Kalman 参数

#### 1. q_beta（Beta 过程噪声）

**原值**: `1e-12`  
**新值**: `1e-8`

**调整原因**：
- 归一化后输入数据量级从几万降到几十
- Beta 的学习目标（0.1-1.0）和输入数据（10-50点）在同一量级
- 原来的 1e-12 太小，可能导致 Beta 几乎不变
- 归一化后可以适当增大，允许 Beta 有轻微适应

**调优范围**：
- `1e-9`: 非常稳定
- `1e-8`: 标准设置（默认）
- `1e-7`: 稍微灵活
- `1e-6`: 更灵活（适合快速变化的市场）

---

#### 2. q_alpha（Alpha 过程噪声）

**原值**: `1e-6`  
**新值**: `1e-4`

**调整原因**：
- 归一化后 Alpha 接近 0，但仍需适应基准价格的长期漂移
- 原来的 1e-6 可能太小
- 归一化后的数据范围允许更大的 Q_alpha 值

**调优范围**：
- `1e-5`: 更保守
- `1e-4`: 标准设置（默认）
- `1e-3`: 更灵活（适合长期运行）

---

#### 3. r_obs（观测噪声）

**原值**: `100.0`  
**新值**: `1.0`

**调整原因**：
- **这是最关键的调整！**
- 归一化后的误差项在 -2 ~ +2 点范围
- R 应该与归一化后的误差项量级匹配
- 原来的 100.0 太大（针对绝对价格的误差）
- 归一化后，1.0 更合理

**调优范围**：
- `0.1-0.5`: 更弱的 Spread（更信任观测）
- `0.5-1.0`: 标准设置（默认）
- `1.0-2.0`: 更强的 Spread（更不信任观测）
- `2.0-5.0`: 非常强的 Spread（如果 Spread 一直为 0，可以尝试）

---

#### 4. init_P（初始协方差）

**原值**: `100.0`  
**新值**: `10.0`

**调整原因**：
- 归一化后 Alpha 接近 0，初始不确定性可以相应减小
- 原来的 100.0 相对于归一化后的数据来说太大

**调优范围**：
- `1.0-5.0`: 保守收敛
- `5.0-10.0`: 标准设置（默认）
- `10.0-50.0`: 快速收敛（适合启动阶段）

---

### Ridge 参数

#### ridge_alpha（岭惩罚系数）

**原值**: `1e-4`  
**新值**: `1e-4`（可保持不变或稍增大）

**说明**：
- 归一化后，Beta 和 Alpha 在同一量级，惩罚系数可以适当增大
- 但 1e-4 已经是一个合理的值，可以保持不变

**调优范围**：
- `1e-5`: 更弱的惩罚
- `1e-4`: 标准设置（默认，可保持不变）
- `1e-3`: 更强惩罚（适合厚市场）

---

## 📝 配置文件更新

### 已更新的默认值

配置文件 `norden_v3/config.py` 已经更新：

```python
KalmanConfig(
    init_P=10.0,      # 从 100.0 减小
    q_beta=1e-8,      # 从 1e-12 增大
    q_alpha=1e-4,     # 从 1e-6 增大
    r_obs=1.0,        # 从 100.0 大幅减小
)
```

### 仪表盘默认值

仪表盘 `run_dashboard_gui.py` 也已更新：

```python
KalmanConfig(
    r_obs=1.0,        # 归一化后的默认值
    q_beta=1e-8       # 归一化后的默认值
)
```

---

## 💡 调优建议

### 如果 Spread 一直为 0

**原因**：R 值太小，模型过度信任观测值

**解决方法**：
1. 增大 `r_obs` 到 2.0-5.0
2. 观察能量柱是否开始显示 Spread

### 如果 Spread 太大或波动剧烈

**原因**：R 值太大，模型太不信任观测值

**解决方法**：
1. 减小 `r_obs` 到 0.5-1.0
2. 或增大 `q_beta`，让模型更稳定

### 如果 Beta 参数乱跳

**原因**：Q_beta 太大，允许 Beta 变化太快

**解决方法**：
1. 减小 `q_beta` 到 1e-9 或 1e-10
2. 或检查数据是否有异常

---

## ⚠️ 重要提醒

1. **R 是最关键的参数**：直接影响 Spread 的大小
2. **参数匹配数据量级**：归一化后，所有参数都应该匹配归一化后的数据范围
3. **先调 R，再调 Q**：先找到合适的 R 值（产生合理的 Spread），再调整 Q 值（控制稳定性）

---

## 🔗 相关文档

- **参数说明**：`norden_v3/配置参数说明.md`
- **归一化说明**：`norden_v3/数据归一化说明.md`
- **配置文件**：`norden_v3/config.py`

---

**最后更新**：2025-01-19  
**状态**：✅ 参数已根据归一化调整

