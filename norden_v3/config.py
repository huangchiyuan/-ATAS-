"""
Norden Engine v3.1 - 集中配置文件
==================================

本文件集中管理所有可配置参数，便于统一调整和文档化。

使用方式：
    from norden_v3.config import (
        MakerConfig,
        KalmanConfig,
        RidgeConfig,
        OBIConfig,
        IcebergConfig,
        BTCRegimeConfig,
    )
    
    # 使用默认配置
    engine = NordenMakerV3()
    
    # 使用自定义配置
    my_config = MakerConfig(base_spread_threshold=1.0)
    engine = NordenMakerV3(maker_cfg=my_config)
"""

from __future__ import annotations

from dataclasses import dataclass


# =============================================================================
# 1. 策略主引擎配置 (MakerConfig)
# =============================================================================

@dataclass
class MakerConfig:
    """
    NordenMakerV3 策略主引擎配置.
    
    这些参数控制策略的高层行为，如信号触发阈值、风险控制等。
    """

    # ========== Spread 触发阈值 ==========
    
    base_spread_threshold: float = 0.5
    """
    Spread 触发阈值（单位：tick）.
    
    说明：
        - 当 |Spread| > 此阈值时，才会触发交易信号
        - Spread = Fair_Price - Actual_Price
        - 0.5 tick = 0.125 点（ES tick size = 0.25）
    
    调优建议：
        - 保守策略：1.0-1.5 tick（减少交易频率，提高胜率）
        - 激进策略：0.3-0.5 tick（增加交易频率，捕获更多机会）
        - 默认 0.5 tick 适合大多数市场环境
    """

    # ========== OBI 过滤参数 ==========
    
    min_obi_for_long: float = 0.1
    """
    做多所需的最小 OBI（Order Book Imbalance）.
    
    说明：
        - OBI 范围：[-1, +1]
        - 正值表示买盘更强（适合做多）
        - 只有当 OBI >= 此值时，才允许做多
    
    调优建议：
        - 0.0：不限制（任何情况下都可以做多）
        - 0.1-0.2：轻微偏向（默认）
        - 0.3+：严格偏向（只在明显买方市场做多）
    """

    min_obi_for_short: float = 0.1
    """
    做空所需的最小 OBI（绝对值）.
    
    说明：
        - 只有当 OBI <= -此值时，才允许做空
        - 负值表示卖盘更强（适合做空）
    
    调优建议：
        - 与 min_obi_for_long 对称设置
        - 如果市场有方向性偏好，可以设置不对称
    """

    obi_depth: int = 10
    """
    OBI 计算深度（使用前 N 档）.
    
    说明：
        - 计算 OBI 时使用的订单簿深度
        - Level 1-3 最重要（真实挂单）
        - Level 10+ 很多是假单
    
    调优建议：
        - 5-10：薄市场，只看关键档位（推荐）
        - 10-15：厚市场，看更多深度（默认）
        - 20+：只看 Level 2 数据（不适合高频）
    """

    # ========== 队列博弈参数 ==========
    
    max_queue_size: int = 300
    """
    最大队列长度阈值（单位：手）.
    
    说明：
        - 如果 Best Bid/Ask 的挂单量 > 此值，则放弃挂单
        - 避免排长队，提高执行效率
        - 当前使用 Best Level 的聚合成交量作为近似值
    
    调优建议：
        - 100-200：薄市场，避免排队
        - 200-300：正常市场（默认）
        - 500+：快市，允许排更长队
    """

    # ========== 时间控制参数 ==========
    
    max_wait_seconds: float = 3.0
    """
    挂单最长等待时间（单位：秒）.
    
    说明：
        - 如果挂单超过此时间仍未成交，自动撤单
        - 防止挂单时间过长，错失其他机会
    
    调优建议：
        - 1.0-2.0：快市，快速撤单
        - 3.0-5.0：正常市场（默认）
        - 10.0+：慢市，允许更长时间等待
    """

    hard_stop_seconds: float = 10.0
    """
    持仓最长持有时间（单位：秒）.
    
    说明：
        - 如果持仓超过此时间，强制平仓
        - 防止持仓时间过长，降低风险
    
    调优建议：
        - 5.0-10.0：短线策略（默认）
        - 10.0-30.0：中线策略
        - 60.0+：长线策略（不推荐）
    """

    # ========== 止盈止损参数 ==========
    
    take_profit_ticks: float = 4.0
    """
    止盈阈值（单位：tick）.
    
    说明：
        - 当持仓盈利 >= 此值时，触发止盈
        - 4.0 tick = 1.0 点（ES tick size = 0.25）
    
    调优建议：
        - 2.0-4.0：短线策略（默认）
        - 4.0-8.0：中线策略
        - 8.0+：长线策略
    """

    hard_stop_ticks: float = 6.0
    """
    止损阈值（单位：tick）.
    
    说明：
        - 当持仓亏损 >= 此值时，触发止损
        - 6.0 tick = 1.5 点（ES tick size = 0.25）
    
    调优建议：
        - 建议设置为 take_profit 的 1.5-2 倍
        - 4.0-6.0：保守策略（默认）
        - 6.0-10.0：激进策略
    """

    # ========== BTC 风险控制参数（已废弃，改用 btc_regime） ==========
    
    max_btc_volatility: float = 1.5
    """
    [已废弃] 最大 BTC 波动率阈值.
    
    说明：
        - 此参数已被 BTCRegimeConfig 替代
        - 保留仅为兼容性，实际不再使用
    """


# =============================================================================
# 2. 卡尔曼滤波配置 (KalmanConfig)
# =============================================================================

@dataclass
class KalmanConfig:
    """
    在线卡尔曼滤波定价模型配置.
    
    这些参数控制卡尔曼滤波器的行为，影响公允价的估计精度和响应速度。
    """

    init_P: float = 10.0
    """
    初始协方差矩阵的主对角线值.
    
    说明：
        - 主要用于 Alpha（截距项）的初始不确定性
        - Beta 的初始方差在 __init__ 中单独缩放（1e-8）
        - **注意**：归一化后 Alpha 接近 0，初始不确定性可以相应减小
        - 值越大，模型越不信任初始值，收敛越快
    
    调优建议：
        - 5.0-10.0：标准设置（默认，适合归一化后的数据量级）
        - 10.0-50.0：快速收敛（适合启动阶段）
        - 1.0-5.0：保守收敛（适合稳定运行）
    """

    q_beta: float = 1e-8
    """
    Beta（斜率）的过程噪声（极度稳定）.
    
    说明：
        - 控制 Beta 在运行过程中的变化速度
        - 值越小，Beta 越稳定（几乎不变）
        - **注意**：模型内部已做基线扣除归一化，输入数据量级从几万降到几十点
        - 归一化后的数据范围通常在 -50 ~ +50 点，参数应匹配归一化后的量级
    
    调优建议：
        - 1e-8：标准设置（默认，适合归一化后的数据量级）
        - 1e-7：稍微灵活（适合快速变化的市场）
        - 1e-9：更保守（Beta 几乎不变）
        - 1e-12：过于保守（可能导致 Beta 无法适应）
    """

    q_alpha: float = 1e-4
    """
    Alpha（截距）的过程噪声（稍微灵活）.
    
    说明：
        - 控制 Alpha 在运行过程中的变化速度
        - Alpha 需要适应价格基准的变化
        - **注意**：归一化后 Alpha 接近 0，但仍需适应基准价格的长期漂移
        - 归一化后的数据范围允许更大的 Q_alpha 值
    
    调优建议：
        - 1e-4：标准设置（默认，适合归一化后的数据量级）
        - 1e-3：更灵活（适合长期运行或基准价格变化大的情况）
        - 1e-5：更保守（Alpha 变化更慢）
    """

    r_obs: float = 1.0
    """
    观测噪声（观测不确定性）.
    
    说明：
        - 控制模型对实际价格的信任程度
        - 值越大，模型越不信任实际价格，保留 Spread
        - **注意**：模型内部已做基线扣除归一化，误差项通常在 -2 ~ +2 点范围
        - 归一化后，R 应该与归一化后的误差项量级匹配
        - 这是产生 Spread 的关键参数！
    
    调优建议：
        - 0.5-1.0：标准设置（默认，适合归一化后的误差量级）
        - 1.0-2.0：更强的 Spread（适合厚市场，更不信任观测）
        - 0.1-0.5：更弱的 Spread（适合薄市场，更信任观测）
        - **重要**：如果 Spread 一直为 0，尝试增大此值到 2.0-5.0
    """


# =============================================================================
# 3. 岭回归配置 (RidgeConfig)
# =============================================================================

@dataclass
class RidgeConfig:
    """
    在线岭回归定价模型配置.
    
    岭回归作为卡尔曼滤波的备用模型，提供对比验证。
    """

    lambda_factor: float = 0.995
    """
    遗忘因子（Forgetting Factor）.
    
    说明：
        - 控制模型对历史数据的记忆长度
        - 值越大，记忆越长（更稳定）
        - 值越小，记忆越短（更灵敏）
    
    记忆长度估算：
        - 0.999 ≈ 过去 1000 tick（稳健）
        - 0.995 ≈ 过去 200 tick（默认）
        - 0.99  ≈ 过去 100 tick（灵敏）
    
    调优建议：
        - 0.99-0.995：快速响应（默认）
        - 0.995-0.999：更稳定（适合趋势市场）
    """

    ridge_alpha: float = 1e-4
    """
    岭惩罚系数（Ridge Penalty）.
    
    说明：
        - 这是产生 Spread 的核心参数！
        - 值越大，模型越"硬"，Spread 越大
        - 防止过拟合，保持模型稳定性
        - **注意**：模型内部已做基线扣除归一化，Beta 和 Alpha 在同一量级
        - 归一化后，1e-4 的惩罚系数仍然适用，因为惩罚是相对比例的
    
    调优建议：
        - 0.0：普通 RLS（Spread 容易被吃光，不推荐）
        - 1e-4：标准惩罚（默认，推荐，适合归一化后的数据）
        - 1e-3：强力惩罚（Spread 很大，但可能滞后）
        - 1e-2：过度惩罚（不推荐）
    """

    init_P: float = 10.0
    """
    初始协方差矩阵值.
    
    说明：
        - 控制模型初始状态的不确定性
        - 与 KalmanConfig.init_P 作用类似
        - **注意**：模型内部已做基线扣除归一化，Alpha 接近 0
        - 归一化后，初始不确定性可以相应减小
    
    调优建议：
        - 与 KalmanConfig.init_P 保持一致（默认 10.0）
        - 5.0-10.0：标准设置（默认，适合归一化后的数据量级）
        - 10.0-50.0：快速收敛（适合启动阶段）
        - 1.0-5.0：保守收敛（适合稳定运行）
    """


# =============================================================================
# 4. OBI 计算配置 (OBIConfig)
# =============================================================================

@dataclass
class OBIConfig:
    """
    加权订单簿失衡度（OBI）计算配置.
    
    OBI 用于衡量订单簿买卖双方的失衡程度，作为微观过滤因子。
    """

    depth: int = 10
    """
    计算深度（使用前 N 档）.
    
    说明：
        - 计算 OBI 时使用的订单簿深度
        - Level 1-3 最重要（真实挂单）
        - Level 10+ 很多是假单或流动性差
    
    调优建议：
        - 5-10：薄市场，只看关键档位（推荐）
        - 10-15：正常市场（默认）
        - 20+：厚市场，但计算成本增加
    """

    decay: float = 0.5
    """
    权重衰减系数.
    
    说明：
        - 控制不同档位的权重分配
        - 值越大，权重衰减越快（更重视近档）
    
    权重分布示例：
        - decay = 0.5 → Level 1=100%, Level 2=50%, Level 3=25%
        - decay = 1.0 → Level 1=100%, Level 2=37%, Level 3=14%（更激进）
        - decay = 0.3 → Level 1=100%, Level 2=70%, Level 3=49%（更均衡）
    
    调优建议：
        - 0.3-0.5：均衡分配（默认）
        - 0.5-0.7：更重视近档
        - 0.1-0.3：更均衡，但可能受假单影响
    """

    auto_adjust_depth: bool = True
    """
    是否自动调整深度.
    
    说明：
        - 如果订单簿档位不足，自动调整到实际可用档位数
        - 避免因为数据不足导致计算错误
    
    建议：
        - True：推荐设置（默认）
        - False：固定深度，可能在某些情况下失效
    """


# =============================================================================
# 5. 冰山检测配置 (IcebergConfig)
# =============================================================================

@dataclass
class IcebergConfig:
    """
    冰山订单检测配置.
    
    冰山检测用于识别隐藏的大单，避免在阻力位挂单。
    """

    min_hidden_size: int = 10
    """
    最小隐藏量阈值（单位：手）.
    
    说明：
        - 只有当隐藏量 >= 此值时，才记录为冰山
        - 用于过滤小单噪音
    
    调优建议：
        - 5-10：敏感（默认，能检测小冰山）
        - 10-20：中等（过滤大部分噪音）
        - 20-50：保守（只检测大冰山）
    """

    decay_seconds: float = 60.0
    """
    冰山衰减时间（单位：秒）.
    
    说明：
        - 超过此时间的冰山记录自动失效
        - 防止过时的冰山信息影响决策
    
    调优建议：
        - 30.0-60.0：标准设置（默认）
        - 60.0-120.0：保守（保留更长时间）
        - 10.0-30.0：敏感（快速失效）
    """

    price_tolerance: float = 1e-5
    """
    价格容差（用于比较价格是否相同）.
    
    说明：
        - 浮点数比较时的容差
        - 由于浮点数精度问题，需要容差来判断价格是否相同
    
    建议：
        - 1e-5：标准设置（默认）
        - 1e-6：更严格
        - 1e-4：更宽松
    """

    check_range_ticks: int = 4
    """
    检查范围（单位：tick）.
    
    说明：
        - 查询阻力/支撑时检查的价格范围
        - 4 tick = 1.0 点（ES tick size = 0.25）
    
    调优建议：
        - 2-4：短线策略（默认）
        - 4-8：中线策略
        - 8+：长线策略
    """


# =============================================================================
# 6. BTC 风险监控配置 (BTCRegimeConfig)
# =============================================================================

@dataclass
class BTCRegimeConfig:
    """
    BTC 风险监控配置.
    
    BTC 体制监控用于检测极端市场波动，触发熔断保护。
    """

    short_window_seconds: int = 60
    """
    短期波动率窗口（单位：秒）.
    
    说明：
        - 计算当前波动率的时间窗口
        - 60 秒 = 1 分钟，反映当下的恐慌程度
    
    调优建议：
        - 30-60：快速响应（默认）
        - 60-120：更稳定
        - 10-30：过于敏感（不推荐）
    """

    long_window_seconds: int = 600
    """
    长期基准波动率窗口（单位：秒）.
    
    说明：
        - 计算基准波动率的时间窗口
        - 600 秒 = 10 分钟，反映背景噪音水平
    
    调优建议：
        - 300-600：标准设置（默认）
        - 600-1200：更稳定
        - 120-300：更敏感
    """

    alert_threshold: float = 3.0
    """
    报警阈值（波动率比率）.
    
    说明：
        - 当 短期波动率 / 基准波动率 > 此值时，触发熔断
        - 3.0 表示当前波动是平时的 3 倍
    
    调优建议：
        - 2.0-2.5：保守策略（更容易触发熔断）
        - 2.5-3.0：标准设置（默认）
        - 3.0-4.0：激进策略（更少触发熔断）
        - 4.0+：非常激进（几乎不触发）
    """

    sample_interval_seconds: float = 1.0
    """
    采样频率（单位：秒）.
    
    说明：
        - 每秒采样一次价格（1Hz）
        - 降低计算成本，同时保持足够的精度
    
    建议：
        - 1.0：标准设置（默认，推荐）
        - 0.5：更高频率（计算成本增加）
        - 2.0：更低频率（可能丢失快速波动）
    """


# =============================================================================
# 7. 预设配置模板
# =============================================================================

class PresetConfigs:
    """
    预设配置模板，方便快速切换策略风格.
    
    使用示例：
        from norden_v3.config import PresetConfigs
        
        # 使用保守配置
        engine = NordenMakerV3(maker_cfg=PresetConfigs.conservative())
    """

    @staticmethod
    def conservative() -> MakerConfig:
        """
        保守配置：低频率，高胜率.
        
        特点：
            - Spread 阈值：1.5 tick
            - 更严格的 OBI 过滤
            - 更快的止盈止损
        """
        return MakerConfig(
            base_spread_threshold=1.5,
            min_obi_for_long=0.2,
            min_obi_for_short=0.2,
            max_queue_size=200,
            max_wait_seconds=2.0,
            take_profit_ticks=3.0,
            hard_stop_ticks=4.0,
        )

    @staticmethod
    def aggressive() -> MakerConfig:
        """
        激进配置：高频率，捕获更多机会.
        
        特点：
            - Spread 阈值：0.3 tick
            - 宽松的 OBI 过滤
            - 更大的止盈止损
        """
        return MakerConfig(
            base_spread_threshold=0.3,
            min_obi_for_long=0.05,
            min_obi_for_short=0.05,
            max_queue_size=400,
            max_wait_seconds=5.0,
            take_profit_ticks=6.0,
            hard_stop_ticks=10.0,
        )

    @staticmethod
    def balanced() -> MakerConfig:
        """
        平衡配置：默认配置（推荐）.
        
        特点：
            - Spread 阈值：0.5 tick
            - 中等严格的过滤
            - 平衡的止盈止损
        """
        return MakerConfig()  # 使用默认值

