# 岭回归参数归一化说明

## ✅ 参数分析

### 1. lambda_factor（遗忘因子）

**当前值**: `0.995`  
**是否需要调整**: ❌ **不需要**

**原因**：
- 遗忘因子是**相对比例**（0-1 之间），表示保留多少历史信息
- 不受数据量级影响，归一化前后都适用
- 0.995 表示每次更新保留 99.5% 的历史信息，衰减 0.5%

**保持默认值**: `0.995`

---

### 2. ridge_alpha（岭惩罚系数）

**当前值**: `1e-4`  
**是否需要调整**: ❌ **不需要**（但注释已更新说明）

**原因**：
- 岭惩罚是通过**权重衰减**实现的：`theta *= (1.0 - ridge_alpha)`
- 这是**相对比例的衰减**，不受数据量级影响
- 归一化后，Beta 和 Alpha 在同一量级（0.1-1.0），所以 1e-4 仍然适用
- 归一化前后，衰减比例相同，效果一致

**示例**：
```python
# 归一化前：Beta = 0.3，衰减后 = 0.3 * (1 - 1e-4) = 0.29997
# 归一化后：Beta = 0.3，衰减后 = 0.3 * (1 - 1e-4) = 0.29997
# 效果相同！
```

**保持默认值**: `1e-4`

---

### 3. init_P（初始协方差矩阵）

**原值**: `100.0`  
**新值**: **`10.0`**  
**是否需要调整**: ✅ **需要调整**

**原因**：
- 配置文件注释要求"与 KalmanConfig.init_P 保持一致"
- Kalman 的 init_P 已经从 100.0 改成了 10.0（归一化后）
- 归一化后，Alpha 接近 0，初始不确定性可以相应减小
- Ridge 的 P 矩阵初始化方式：`self.P = np.eye(3) * self.cfg.init_P`
- 所有元素（包括 Alpha）都使用相同的 init_P 值

**调整**：
- **已更新为**: `10.0`（与 Kalman 保持一致）

**调优范围**：
- `5.0-10.0`: 标准设置（默认）
- `10.0-50.0`: 快速收敛（适合启动阶段）
- `1.0-5.0`: 保守收敛（适合稳定运行）

---

## 📊 参数对比总结

| 参数 | 原值 | 新值 | 是否调整 | 原因 |
|------|------|------|---------|------|
| `lambda_factor` | 0.995 | **0.995** | ❌ 否 | 相对比例，不受归一化影响 |
| `ridge_alpha` | 1e-4 | **1e-4** | ❌ 否 | 相对比例衰减，不受归一化影响 |
| `init_P` | 100.0 | **10.0** | ✅ 是 | 归一化后 Alpha 接近 0，应减小 |

---

## 🔍 详细说明

### 为什么 lambda_factor 不需要调整？

遗忘因子是相对比例的机制：
```python
# 每次更新时
self.P = (self.P - np.outer(k, Px)) / self.cfg.lambda_factor
```

- `lambda_factor = 0.995` 表示：保留 99.5% 的历史信息，衰减 0.5%
- 这是**比例关系**，不受数据量级影响
- 归一化前后的效果完全一致

---

### 为什么 ridge_alpha 不需要调整？

岭惩罚是通过权重衰减实现的：
```python
decay_vector = np.array([
    1.0 - self.cfg.ridge_alpha,  # Beta_NQ 衰减
    1.0 - self.cfg.ridge_alpha,  # Beta_YM 衰减
    1.0                          # Alpha 不衰减
])
self.theta *= decay_vector
```

- `ridge_alpha = 1e-4` 表示：每次更新，Beta 衰减 0.01%
- 这是**相对比例的衰减**，不受数据量级影响
- 归一化前：Beta=0.3 → 衰减后=0.29997
- 归一化后：Beta=0.3 → 衰减后=0.29997
- **效果相同！**

---

### 为什么 init_P 需要调整？

初始协方差矩阵控制初始状态的不确定性：

```python
# Ridge 初始化
self.P = np.eye(3, dtype=float) * self.cfg.init_P
# 所有元素都是 init_P（包括 Alpha）

# Kalman 初始化（作为对比）
self.P = np.diag([1e-8, 1e-8, self.cfg.init_P])
# Beta 用 1e-8，Alpha 用 init_P
```

**归一化前**：
- Alpha 可能很大（几千），需要大的初始不确定性（100.0）

**归一化后**：
- Alpha 接近 0，初始不确定性可以减小
- Kalman 已经调整为 10.0
- Ridge 应该保持一致

---

## ✅ 最终配置

### 推荐配置

```python
RidgeConfig(
    lambda_factor=0.995,   # 保持不变（相对比例）
    ridge_alpha=1e-4,      # 保持不变（相对比例衰减）
    init_P=10.0,           # 已更新（与 Kalman 一致）
)
```

### 配置文件状态

✅ **已更新** `norden_v3/config.py`：
- `lambda_factor`: 0.995（保持不变，注释已说明）
- `ridge_alpha`: 1e-4（保持不变，注释已更新说明归一化）
- `init_P`: **10.0**（已从 100.0 更新）

---

## 💡 调优建议

### 如果 Ridge Spread 一直为 0

**原因**：岭惩罚太轻，模型过度拟合

**解决方法**：
1. 增大 `ridge_alpha` 到 1e-3 或 5e-4
2. 观察能量柱是否开始显示 Spread

### 如果 Ridge Spread 太大或波动剧烈

**原因**：岭惩罚太重，模型太僵硬

**解决方法**：
1. 减小 `ridge_alpha` 到 1e-5
2. 或增大 `lambda_factor`，让模型更稳定

### 如果 Ridge 参数收敛太慢

**原因**：初始不确定性太小

**解决方法**：
1. 增大 `init_P` 到 50.0-100.0（快速收敛）
2. 但注意：这会增加启动阶段的噪声

---

## 🔗 相关文档

- **参数说明**：`norden_v3/配置参数说明.md`
- **归一化说明**：`norden_v3/数据归一化说明.md`
- **Kalman 参数调整**：`norden_v3/归一化参数调整说明.md`
- **配置文件**：`norden_v3/config.py`

---

**最后更新**：2025-01-19  
**状态**：✅ 参数已检查并更新（仅 init_P 需要调整）

