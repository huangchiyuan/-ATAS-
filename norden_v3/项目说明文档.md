# Norden Engine v3.1 项目说明文档

## 📋 项目概述

**Norden Engine v3.1 (Institutional Maker)** 是一个专为 CME ES/NQ 期货设计的机构级混合做市策略引擎。该系统基于 Gary Norden 的"不预测，只反应"交易哲学，通过捕获高频的统计学微小优势（1-3 ticks），利用**频率复合边际 (Edge × Frequency)** 效应积累稳定收益。

### 核心特点

- ✅ **成本驱动**：专注于赚取价差，适应高交易费用环境
- ✅ **动态适应**：使用在线卡尔曼滤波实时调整参数
- ✅ **多层次过滤**：模型层、微观层、风险层、队列层四重过滤
- ✅ **防御机制**：冰山订单检测、BTC 风险监控、队列博弈

---

## 🏗️ 核心架构

### 1. 数据流架构

```
C# ATAS 平台
  ↓ (UDP 协议，端口 5555)
Python UdpListener
  ↓ (事件队列)
策略引擎 (NordenMakerV3)
  ├─→ 定价模型（Kalman / Ridge）
  ├─→ 微观因子（OBI）
  ├─→ 防御因子（Iceberg）
  └─→ 风控检查（BTC Regime）
  ↓
交易信号 (OrderCommand)
```

### 2. 决策流程

```
Tick 事件
  ↓
Layer 1: 定价模型
  ├─ Kalman Filter：在线估计 ES 公允价
  └─ Ridge Regression：备用定价模型
  ↓
Layer 2: Spread 触发
  ├─ 计算价差 (Spread = Fair - Actual)
  └─ 判断是否超过阈值
  ↓
Layer 3: 多重过滤
  ├─ BTC 风险监控（熔断保护）
  ├─ 冰山订单检测（防御阻力）
  └─ OBI 过滤（订单簿失衡度）
  ↓
Layer 4: 队列博弈
  ├─ 估计队列长度
  └─ 判断是否值得排队
  ↓
执行决策
  ├─ 挂单（Limit Order）
  ├─ 撤单（超时/信号反转）
  └─ 止盈止损（已持仓）
```

---

## 📦 核心模块

### 1. 定价引擎

#### 1.1 在线卡尔曼滤波 (`kalman_model.py`)

**功能**：实时估计 ES 公允价，基于 NQ/YM 相关性

**核心算法**：
- 状态向量：`theta = [beta_NQ, beta_YM, alpha]`
- 观测方程：`ES_t = beta_NQ * NQ_t + beta_YM * YM_t + alpha + noise`
- 在线更新：使用卡尔曼滤波递归估计参数

**特点**：
- ✅ 自适应参数调整
- ✅ 处理缺失数据（YM 可能缺失）
- ✅ Baseline 归一化（解决数量级差异）
- ✅ 矩阵缩放优化（提高数值稳定性）

#### 1.2 在线岭回归 (`ridge_model.py`)

**功能**：备用定价模型，与 Kalman 并行计算

**核心算法**：
- 带遗忘因子的岭回归
- L2 正则化防止过拟合
- 在线更新，实时调整

**特点**：
- ✅ 与 Kalman 模型对比验证
- ✅ 提供冗余保障

---

### 2. 微观因子

#### 2.1 加权订单簿失衡度 (`obi_calculator.py`)

**功能**：计算订单簿买卖失衡程度

**核心算法**：
- 加权 Bid/Ask 量：使用指数衰减权重
- OBI = (Weighted_Bid - Weighted_Ask) / (Weighted_Bid + Weighted_Ask)
- 范围：[-1, +1]

**特点**：
- ✅ 深度可配置（默认 10 档）
- ✅ 时间衰减权重（近档权重更大）
- ✅ 高效向量化计算（NumPy）

#### 2.2 冰山订单检测 (`iceberg_detector.py`)

**功能**：识别隐藏的大单，避免在阻力位挂单

**核心算法**：
- 比较成交量 vs 可见挂单量
- 如果成交量 ≥ 挂单量，但价格未变 → 发现冰山
- 记录隐藏量和价格位置

**特点**：
- ✅ 批量成交聚合（处理推送碎片化）
- ✅ 时间衰减（60 秒后失效）
- ✅ 查询接口（检查上方阻力/下方支撑）

---

### 3. 风险控制

#### 3.1 BTC 体制监控 (`btc_regime.py`)

**功能**：检测极端市场波动，触发熔断保护

**核心算法**：
- 计算相对波动率：`Ratio = 短期波动率 / 基准波动率`
- 如果 `Ratio > 3.0` → 触发熔断
- 使用对数收益率计算波动率

**特点**：
- ✅ 自适应基准（10 分钟滚动窗口）
- ✅ 降频采样（每秒一次，降低 CPU）
- ✅ 自动熔断（拒绝所有交易信号）

---

### 4. 策略引擎

#### 4.1 主引擎 (`maker_engine.py`)

**功能**：整合所有模块，执行交易决策

**核心流程**：
1. 接收 Tick 事件 → 更新定价模型
2. 计算 Spread → 判断是否触发信号
3. 多重过滤 → 检查 BTC/冰山/OBI
4. 队列博弈 → 估计排队成本
5. 执行决策 → 生成订单指令

**特点**：
- ✅ 模块化设计，易于扩展
- ✅ 事件驱动架构
- ✅ 可配置参数（MakerConfig）

---

## 📁 文件结构

```
norden_v3/
├── __init__.py              # 模块导出
├── types.py                 # 数据类型定义
├── kalman_model.py          # 卡尔曼滤波定价
├── ridge_model.py           # 岭回归定价
├── obi_calculator.py        # OBI 计算
├── iceberg_detector.py      # 冰山检测
├── btc_regime.py            # BTC 风险监控
├── maker_engine.py          # 策略主引擎
├── README.md                # 快速开始
├── TESTING.md               # 测试指南
├── 数据归一化说明.md        # 技术文档
├── 冰山检测说明.md          # 功能文档
└── BTC风险监控说明.md       # 功能文档
```

---

## 🚀 快速开始

### 1. 基本使用

```python
from norden_v3 import NordenMakerV3, TickEvent, DomSnapshot, Side

# 创建策略引擎
def order_handler(cmd):
    print(f"订单: {cmd}")

engine = NordenMakerV3(order_sink=order_handler)

# 处理 Tick 事件
tick = TickEvent(
    t_ms=1234567890,
    es=6857.25,
    nq=21500.50,
    ym=44000.00,
    btc=95000.00
)
engine.on_tick(tick)

# 处理 DOM 事件
dom = DomSnapshot(
    t_ms=1234567890,
    best_bid=6857.25,
    best_ask=6857.50,
    bids=[(6857.25, 74), ...],
    asks=[(6857.50, 77), ...]
)
engine.on_dom(dom)
```

### 2. 运行完整测试

```bash
python run_norden_v3_test.py
```

### 3. 配置参数

```python
from norden_v3 import MakerConfig, KalmanConfig

# 策略配置
maker_cfg = MakerConfig(
    base_spread_threshold=0.5,    # 0.5 tick 触发阈值
    min_obi_for_long=0.1,         # 做多最小 OBI
    min_obi_for_short=0.1,        # 做空最小 OBI
    obi_depth=10,                 # OBI 计算深度
    max_queue_size=300,           # 最大队列长度
)

# 卡尔曼配置
kalman_cfg = KalmanConfig(
    init_P=100.0,                 # 初始协方差
    q_beta=1e-12,                 # 过程噪声
    r_obs=100.0,                  # 观测噪声
)

engine = NordenMakerV3(
    maker_cfg=maker_cfg,
    kalman_cfg=kalman_cfg
)
```

---

## 📊 输出示例

### 状态输出

```
[STATUS] ES=6857.25 | Fair_KF= 6857.47 Spread_KF= +0.87tick | Fair_RD= 6857.45 Spread_RD= +0.80tick | OBI=-0.034 | Queue: B=  74 A=  77 | 🟢 BTC:1.2x | Iceberg: None | Order: None
```

**字段说明：**
- `Fair_KF`：Kalman 公允价
- `Spread_KF`：Kalman 价差（tick）
- `Fair_RD`：Ridge 公允价
- `Spread_RD`：Ridge 价差（tick）
- `OBI`：订单簿失衡度
- `Queue`：队列长度（Bid/Ask）
- `BTC`：BTC 风险状态（🟢安全 / 🔴熔断）
- `Iceberg`：冰山检测结果
- `Order`：当前挂单状态

### 订单输出

```
[ORDER] 下单: BUY 1@6857.00 (LIMIT, reason: maker_entry_buy)
[ORDER] 撤单: local_1234567890 (timeout_cancel)
```

---

## 🔧 配置说明

### MakerConfig 参数

| 参数 | 默认值 | 说明 |
|------|--------|------|
| `base_spread_threshold` | 0.5 | Spread 触发阈值（tick） |
| `min_obi_for_long` | 0.1 | 做多最小 OBI |
| `min_obi_for_short` | 0.1 | 做空最小 OBI |
| `obi_depth` | 10 | OBI 计算深度 |
| `max_queue_size` | 300 | 最大队列长度 |

### KalmanConfig 参数

| 参数 | 默认值 | 说明 |
|------|--------|------|
| `init_P` | 100.0 | 初始协方差矩阵 |
| `q_beta` | 1e-12 | Beta 过程噪声 |
| `q_alpha` | 1e-6 | Alpha 过程噪声 |
| `r_obs` | 100.0 | 观测噪声 |

---

## 📈 性能优化

### 1. 数据归一化

- **Baseline 扣除**：所有输入价格减去基准价格
- **效果**：解决 NQ/YM/ES 数量级差异问题
- **实现**：在模型初始化时记录基准价

### 2. 矩阵缩放

- **问题**：NQ/YM 价格 (~20000) vs Beta (~0.3) 数量级差异
- **解决**：给 Beta 极小的初始方差 (1e-8)
- **效果**：矩阵运算更稳定，Spread 更准确

### 3. 降频采样

- **BTC 监控**：每秒采样一次（而非每 tick）
- **效果**：CPU 占用极低，不影响实时性

---

## 🛡️ 风险控制

### 1. BTC 熔断机制

- **触发条件**：波动率比率 > 3.0
- **效果**：拒绝所有新交易信号
- **恢复**：市场稳定后自动恢复

### 2. 冰山防御

- **检测方法**：成交量 vs 挂单量比较
- **应用**：检查目标方向是否有大单阻力
- **阈值**：隐藏量 > 200 手拒绝交易

### 3. 队列博弈

- **估计方法**：Best Bid/Ask 挂单量
- **阈值**：队列长度 > 300 拒绝挂单
- **逻辑**：避免排长队，优先执行

---

## 📚 技术文档

### 核心算法文档

- `数据归一化说明.md`：Baseline 扣除方法详解
- `冰山检测说明.md`：冰山订单检测原理
- `BTC风险监控说明.md`：相对波动率算法

### 测试文档

- `TESTING.md`：测试指南和用例

---

## 🔄 版本历史

### v3.1 (当前版本)

- ✅ 在线卡尔曼滤波定价引擎
- ✅ 在线岭回归备用模型
- ✅ 加权 OBI 计算
- ✅ 冰山订单检测
- ✅ BTC 风险监控
- ✅ 完整的多层过滤体系

---

## 🎯 下一步计划

### 待实现功能

- [ ] 完整的 MBO 队列长度计算
- [ ] 止盈止损逻辑优化
- [ ] 回测框架集成
- [ ] 性能指标统计

---

## 📞 技术支持

如有问题，请参考：
- 项目文档：`README.md`
- 测试脚本：`run_norden_v3_test.py`
- 代码注释：各模块均有详细注释

---

**最后更新**：2025-01-19  
**项目版本**：Norden Engine v3.1 (Institutional Maker)

