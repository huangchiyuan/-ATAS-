# 参数归一化调整说明

## 🔍 问题分析

### 当前状况

模型内部已经做了**基线扣除归一化（Baseline Subtraction）**：
- 输入数据从 `[21000, 44000, 6800]` 变成 `[10.5, -5.0, 2.0]`
- 数据量级从**几万**降到了**几十**
- 所有计算都在归一化后的"相对点数"空间进行

### 参数现状

当前参数是基于**未归一化**的大数值设计的：
- `q_beta = 1e-12` - 非常小，适合大数值
- `q_alpha = 1e-6` - 也很小
- `r_obs = 100.0` - 观测噪声，针对绝对价格

---

## 📊 归一化后的数据范围

### 实际数据范围

归一化后（相对点数空间）：
- **NQ delta**: 通常在 -50 ~ +50 点（正常波动）
- **YM delta**: 通常在 -50 ~ +50 点
- **ES delta**: 通常在 -10 ~ +10 点
- **误差项 (error)**: 通常在 -2 ~ +2 点

### 参数合理范围

归一化后的参数应该匹配数据量级：

| 参数 | 归一化前 | 归一化后 | 说明 |
|------|---------|---------|------|
| **输入数据** | 21000 | +10.5 | 量级缩小 2000 倍 |
| **误差项** | 可能很大 | -2 ~ +2 点 | 量级缩小很多 |
| **Q (过程噪声)** | 1e-12 | 应该增大 | 相对数据范围应匹配 |
| **R (观测噪声)** | 100.0 | 应该减小 | 误差项已变小 |

---

## ✅ 推荐参数调整

### Kalman 参数调整

#### 1. q_beta（Beta 过程噪声）

**当前值**: `1e-12`  
**归一化后推荐值**: `1e-8` 到 `1e-6`

**原因**：
- 归一化后 Beta 的学习目标（0.1-1.0）和输入数据（10-50点）在同一量级
- 原来 1e-12 太小，可能导致 Beta 几乎不变
- 归一化后可以适当增大，允许 Beta 有轻微适应

**推荐值**：
- `1e-8`: 稳定（默认）
- `1e-7`: 稍微灵活
- `1e-6`: 更灵活（适合快速变化的市场）

---

#### 2. q_alpha（Alpha 过程噪声）

**当前值**: `1e-6`  
**归一化后推荐值**: `1e-4` 到 `1e-3`

**原因**：
- 归一化后 Alpha 接近 0，但仍需要适应基准价格的变化
- 原来的 1e-6 可能太小
- Alpha 需要适应基准价格的长期漂移

**推荐值**：
- `1e-4`: 标准设置（默认）
- `1e-3`: 更灵活（适合长期运行）

---

#### 3. r_obs（观测噪声）

**当前值**: `100.0`  
**归一化后推荐值**: `0.5` 到 `2.0`

**原因**：
- 归一化后的误差项在 -2 ~ +2 点范围
- R 应该与误差项的方差匹配
- 原来的 100.0 太大（针对绝对价格的误差）
- 归一化后，0.5-2.0 更合理

**推荐值**：
- `1.0`: 标准设置（默认）
- `0.5`: 更信任观测（Spread 更小）
- `2.0`: 更不信任观测（Spread 更大）

---

### Ridge 参数调整

#### 1. ridge_alpha（岭惩罚系数）

**当前值**: `1e-4`  
**归一化后推荐值**: `1e-4` 到 `1e-3`（可保持不变或稍增大）

**原因**：
- 归一化后，Beta 和 Alpha 在同一量级，惩罚系数可以适当增大
- 目的是防止过拟合，保留 Spread

**推荐值**：
- `1e-4`: 标准设置（可保持不变）
- `1e-3`: 更强惩罚（适合厚市场）

---

#### 2. lambda_factor（遗忘因子）

**当前值**: `0.995`  
**可保持不变**

**原因**：
- 遗忘因子是相对比例，不受归一化影响

---

## 📝 调整建议总结

### 必须调整的参数

| 参数 | 当前值 | 推荐值 | 调整原因 |
|------|--------|--------|---------|
| `q_beta` | 1e-12 | **1e-8** | 归一化后数据量级变小，应增大 |
| `q_alpha` | 1e-6 | **1e-4** | 归一化后应允许更多适应 |
| `r_obs` | 100.0 | **1.0** | 归一化后误差项变小，应大幅减小 |

### 可保持不变的参数

- `ridge_alpha`: 1e-4（可以保持不变或稍增大）
- `lambda_factor`: 0.995（不受归一化影响）
- `init_P`: 100.0（可以保持不变，或适当减小到 10.0）

---

## ⚠️ 重要说明

### 参数调整的原则

1. **Q（过程噪声）**：
   - 归一化后数据量级变小，Q 应该**相对增大**
   - 但 Beta 的稳定性要求依然存在，不能太大

2. **R（观测噪声）**：
   - 归一化后误差项变小，R 应该**大幅减小**
   - 这是**最关键的调整**，影响 Spread 大小

3. **保持平衡**：
   - Q 和 R 的**相对比例**更重要
   - R/Q 的比值应该保持在合理范围

---

## 🔧 建议的新参数配置

### 保守配置（稳定）

```python
KalmanConfig(
    q_beta=1e-8,      # 从 1e-12 增大
    q_alpha=1e-4,     # 从 1e-6 增大
    r_obs=1.0,        # 从 100.0 大幅减小
    init_P=10.0,      # 从 100.0 减小
)
```

### 平衡配置（推荐）

```python
KalmanConfig(
    q_beta=1e-7,      # 稍微灵活
    q_alpha=1e-4,     # 标准
    r_obs=1.0,        # 标准
    init_P=10.0,      # 适当减小
)
```

### 灵活配置（快速响应）

```python
KalmanConfig(
    q_beta=1e-6,      # 更灵活
    q_alpha=1e-3,     # 更灵活
    r_obs=0.5,        # 更信任观测
    init_P=10.0,
)
```

---

**关键点**：归一化后，参数值应该与归一化后的数据量级匹配，而不是原始价格量级。

