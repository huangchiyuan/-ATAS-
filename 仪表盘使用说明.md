# Norden Engine v3.1 策略驾驶舱使用说明

## 📋 概述

**策略驾驶舱 (Strategy Dashboard)** 是一个专门为 Norden Engine v3.1 设计的可视化监控工具。它不是传统的 K 线图表，而是将策略的"大脑"可视化，让你能够：

1. **直观理解策略决策**：不再看价格曲线，而是看 Spread（套利空间）信号
2. **实时调整参数**：在运行中拖动滑块修改参数，立即看到效果
3. **透明化过滤器**：通过红绿灯式状态显示，一眼看清哪些条件满足/不满足

---

## 🚀 快速开始

### 1. 安装依赖

```bash
pip install PyQt6 pyqtgraph
```

### 2. 启动数据源

确保 ATAS 平台的 **NFQE_Bridge_UDP** 指标已加载并运行：
- 实盘模式：连接到实盘数据
- 回放模式：加载历史数据进行回放测试

### 3. 启动仪表盘

```bash
python run_dashboard_gui.py
```

---

## 🖥️ 界面说明

### 区域 1：顶部指令区（The Action）

**作用**：显示策略的最终决策

**显示内容**：
- 🟢 **BUY LIMIT @ 价格**：所有条件满足，策略建议做多
- 🔴 **SELL LIMIT @ 价格**：所有条件满足，策略建议做空
- 🟡 **信号被过滤 (原因)**：有信号但被过滤器拦截
- ⏳ **等待信号**：当前没有交易信号

**颜色含义**：
- 绿色背景 = 买入信号
- 红色背景 = 卖出信号
- 黄色背景 = 信号被过滤
- 灰色背景 = 等待状态

---

### 区域 2：价格显示面板

显示实时价格：
- **ES**：E-mini S&P 500 期货价格
- **NQ**：E-mini NASDAQ-100 期货价格
- **YM**：E-mini Dow 期货价格
- **BTC**：BTCUSDT 价格（用于风险监控）

---

### 区域 3：过滤器状态矩阵（Filters）

通过红绿灯式状态显示各个过滤器的状态：

#### 🟢 Model Spread（核心信号灯）

**含义**：模型的 Spread 信号状态

**状态**：
- 🟢 **绿色（Long）**：Spread > 阈值，适合做多
- 🔴 **红色（Short）**：Spread < -阈值，适合做空
- ⚫ **灰色（Neutral）**：Spread 在阈值范围内，无信号

**数值显示**：当前 Spread（单位：tick）

---

#### 🟢 OBI Flow（订单簿失衡）

**含义**：订单簿买卖失衡程度

**状态**：
- 🟢 **绿色（Bullish）**：买盘强（OBI > 阈值），支持做多
- 🔴 **红色（Bearish）**：卖盘强（OBI < -阈值），支持做空
- ⚫ **灰色（Flat）**：买卖平衡

**数值显示**：当前 OBI 值（范围：-1 到 +1）

---

#### 🟢 Iceberg（冰山订单）

**含义**：检测到的大单阻力/支撑

**状态**：
- 🟢 **绿色（Clean）**：无大冰山，可以交易
- 🔴 **红色（Resist/Support）**：检测到大冰山，可能阻碍交易

**数值显示**：阻力/支撑总量（单位：手）

---

#### 🟢 BTC Risk（BTC 风险监控）

**含义**：BTC 市场波动率风险

**状态**：
- 🟢 **绿色（Safe）**：市场安全，可以交易
- 🔴 **红色（ALERT）**：市场异常波动，触发熔断

**数值显示**：波动率比率（当前波动 / 基准波动）

---

### 区域 4：信号可视化（Spread Chart）

**作用**：实时显示 Spread 信号曲线和阈值线

**图表元素**：
- **黄色曲线**：Spread 值（单位：tick）
- **绿色虚线**：上阈值线（做多触发线）
- **红色虚线**：下阈值线（做空触发线）
- **灰色虚线**：0 轴参考线

**观察要点**：
- 当黄色曲线突破绿色虚线时 → 触发做多信号
- 当黄色曲线跌破红色虚线时 → 触发做空信号
- 曲线波动幅度过大 → 可能需要调整 Kalman R 参数

---

### 区域 5：实时参数调整面板

可以在运行中实时调整关键参数，立即看到效果：

#### 1. Spread 阈值（Ticks）

**作用**：控制触发交易信号的 Spread 大小

**调优建议**：
- **0.25-0.5**：激进策略，捕获更多机会，但可能产生假信号
- **0.5-0.75**：平衡策略（默认）
- **0.75-1.5**：保守策略，只做高确信信号

**操作**：拖动滑块或直接输入数值，阈值线会立即更新

---

#### 2. Kalman R（观测噪声）

**作用**：控制模型对实际价格的信任程度，影响 Spread 的大小

**调优建议**：
- **值越小（< 50）**：模型更信任实际价格，Spread 较小，信号少但准确
- **值适中（50-150）**：平衡设置（默认 100）
- **值越大（> 150）**：模型不太信任实际价格，Spread 较大，信号多但可能滞后

**现象判断**：
- 如果 Spread 曲线乱跳（噪音大）→ **增大 R**
- 如果 Spread 一直为 0（模型过度拟合）→ **增大 R**
- 如果 Spread 变化太慢（滞后）→ **减小 R**

---

#### 3. 最小 OBI

**作用**：控制 OBI 过滤器的最低要求

**调优建议**：
- **0.0-0.1**：宽松过滤，允许在平衡市场交易
- **0.1-0.2**：标准过滤（默认 0.1）
- **0.2+**：严格过滤，只在明显偏向的市场交易

**操作**：调整后，OBI 状态灯会立即反映新的阈值要求

---

#### 4. Kalman Q Beta

**作用**：控制 Beta 参数（斜率）的稳定性

**调优建议**：
- 一般不建议频繁调整
- 如果 Beta 参数乱跳 → **减小 Q Beta**（使其更稳定）
- 如果模型响应太慢 → **增大 Q Beta**（允许更多变化）

**注意**：此参数修改后需要重启模型才能完全生效

---

## 📊 使用场景

### 场景 1：参数调优

**目标**：找到适合当前市场的参数组合

**步骤**：
1. 观察 Spread 曲线，看是否有信号触发
2. 如果信号太少 → 降低 Spread 阈值或增大 Kalman R
3. 如果信号太多（假信号）→ 提高 Spread 阈值或减小 Kalman R
4. 观察过滤器状态，看哪个过滤器经常拦截信号
5. 如果 OBI 经常拦截 → 降低最小 OBI 阈值
6. 如果 BTC Risk 经常触发 → 检查市场是否有异常波动

---

### 场景 2：策略理解

**目标**：理解策略为什么做出某个决策

**步骤**：
1. 观察顶部指令区，看当前信号是什么
2. 查看过滤器状态：
   - Model Spread 是什么颜色？Spread 值是多少？
   - OBI 是什么状态？支持还是反对？
   - 是否有冰山订单阻碍？
   - BTC 市场是否安全？
3. 如果信号被过滤，查看黄色提示中的原因
4. 查看 Spread 图表，看信号强度如何

---

### 场景 3：实时监控

**目标**：在实盘中监控策略状态

**步骤**：
1. 保持仪表盘打开，放在副屏
2. 主要关注：
   - 顶部指令区的大字提示（绿色/红色）
   - Model Spread 信号灯的颜色
   - BTC Risk 是否触发红色警报
3. 当出现绿色/红色指令时，结合其他过滤器状态判断是否执行

---

## ⚠️ 注意事项

### 1. 参数调整

- **实时调整**：Spread 阈值、OBI 阈值可以立即生效
- **部分生效**：Kalman R 可以实时调整，但可能需要几个 tick 才能完全生效
- **需要重启**：Kalman Q Beta 修改后建议重启策略引擎

### 2. 数据要求

- **必需数据**：ES 和 NQ 价格（缺一不可）
- **可选数据**：YM、BTC（没有也能运行，但功能受限）
- **DOM 数据**：用于 OBI 和冰山检测（没有也能运行，但无法计算 OBI）

### 3. 性能

- **刷新频率**：约 33 FPS（30ms 刷新间隔）
- **历史数据**：保留最近 1000 个数据点
- **内存占用**：通常 < 100MB

### 4. 回放加速

- 支持 ATAS 的加速回放（10x、100x、500x）
- 仪表盘会自动处理数据队列，不会卡顿
- 建议在回放测试时使用，实盘时使用正常速度

---

## 🐛 常见问题

### Q1: 仪表盘显示"等待数据中..."

**原因**：没有收到 UDP 数据

**解决方案**：
1. 检查 ATAS 的 NFQE_Bridge_UDP 指标是否加载
2. 检查 UDP 端口是否正确（默认 5555）
3. 检查防火墙是否阻止了 UDP 通信
4. 查看终端是否有错误信息

---

### Q2: Spread 曲线一直是 0

**原因**：模型可能过度拟合，或者数据不足

**解决方案**：
1. 增大 Kalman R 参数（例如改为 150 或 200）
2. 检查是否同时收到 ES、NQ、YM 数据
3. 等待一段时间，让模型稳定

---

### Q3: 信号被频繁过滤

**原因**：过滤器阈值设置过严

**解决方案**：
1. 查看哪个过滤器经常拦截（看状态灯颜色）
2. 如果 OBI 拦截 → 降低最小 OBI 阈值
3. 如果 BTC Risk 拦截 → 检查市场是否真的有异常
4. 如果冰山拦截 → 这是正常的防御机制，建议保留

---

### Q4: 性能卡顿

**原因**：数据量过大或刷新频率过高

**解决方案**：
1. 减少历史数据长度（修改 `max_history` 参数）
2. 降低刷新频率（修改 `timer.start(30)` 为更大的值）
3. 关闭其他占用资源的程序

---

## 📝 配置文件

仪表盘使用策略引擎的配置文件（`norden_v3/config.py`），但可以通过界面实时调整以下参数：

- `base_spread_threshold`（Spread 阈值）
- `r_obs`（Kalman R）
- `min_obi_for_long/short`（OBI 阈值）
- `q_beta`（Kalman Q Beta，需要重启生效）

其他参数需要修改配置文件后重启仪表盘。

---

## 🔗 相关文档

- **策略说明**：`norden_v3/项目说明文档.md`
- **配置参数**：`norden_v3/配置参数说明.md`
- **项目总览**：`README.md`

---

**最后更新**：2025-01-19  
**版本**：v1.0

