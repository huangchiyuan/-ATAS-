# Norden v3.1 回测系统使用说明

## 📋 概述

Norden v3.1 回测系统是一个**完整的模拟回测与轨迹追踪系统**，它作为策略引擎的"外挂模块"，通过 Hook（钩子）机制拦截策略的下单指令，并自动开启对该指令的**全生命周期追踪**。

### 核心功能

1. **信号监听**：自动捕获策略发出的所有交易信号
2. **轨迹追踪**：追踪信号发出后 N 秒内的价格走势
3. **性能分析**：计算 MFE（最大潜在利润）和 MAE（最大潜在亏损）
4. **统计报告**：自动生成 CSV 报告，包含详细的交易统计

---

## 🚀 快速开始

### 1. 准备工作

确保你已经：
- ✅ 安装了所有依赖（pandas, numpy 等）
- ✅ ATAS 中已加载 `NFQE_Bridge_UDP` 指标到 ES/NQ/YM 图表
- ✅ 策略参数已配置完成

### 2. 运行回测

```bash
python run_backtest.py
```

### 3. 在 ATAS 中开始回放

1. 打开 ATAS，进入 Replay 模式
2. 选择你想测试的历史日期
3. 将播放速度设置为 **100x** 或 **1000x**（推荐）
4. 开始回放

### 4. 结束回测

当你想结束回测时，在 Python 窗口中按 `Ctrl+C`。

系统会自动：
- 停止数据接收
- 生成统计报告 CSV
- 打印统计摘要

---

## 📊 输出报告说明

### CSV 报告文件

程序会在目录下生成一个 `Sim_Backtest_YYYYMMDD_HHMMSS.csv` 文件，包含每一笔信号的详细信息。

#### 关键字段说明

| 字段 | 说明 | 示例 |
|------|------|------|
| `signal_id` | 信号编号 | 1, 2, 3... |
| `timestamp` | 信号时间戳（毫秒） | 1704067200000 |
| `time_str` | 可读时间 | 14:30:15 |
| `side` | 交易方向 | BUY / SELL |
| `entry_price` | 入场价格 | 6866.75 |
| `fair_price` | 当时的理论价 | 6866.79 |
| `spread_ticks` | 价差（tick） | 0.16 |
| `obi` | 订单簿失衡度 | 0.15 |
| `queue_len` | 队列长度 | 71 |
| `btc_ratio` | BTC 波动率比率 | 1.2 |
| `pnl_1s` | 1秒后的浮盈亏（tick） | 0.5 |
| `pnl_5s` | 5秒后的浮盈亏（tick） | 1.2 |
| `pnl_10s` | 10秒后的浮盈亏（tick） | 2.0 |
| `pnl_30s` | 30秒后的浮盈亏（tick） | 3.5 |
| `mfe_ticks` | 最大浮盈（tick） | 4.5 |
| `mae_ticks` | 最大浮亏（tick） | -0.5 |
| `hit_tp` | 是否触及止盈 | True / False |
| `hit_sl` | 是否触及止损 | True / False |

---

## 📈 关键指标解释

### MFE (Max Favorable Excursion)

**最大潜在利润**，表示信号发出后，价格往有利方向移动的最大幅度。

- **意义**：如果 MFE > 4 ticks，说明有足够的空间设置 +4 ticks 的止盈
- **用途**：评估止盈策略是否合理

### MAE (Max Adverse Excursion)

**最大潜在亏损**，表示信号发出后，价格往不利方向移动的最大幅度。

- **意义**：如果 MAE < -6 ticks，说明可能需要调整止损位置
- **用途**：评估止损策略是否合理

### Win Rate（胜率）

基于虚拟止盈止损（+4 ticks 止盈，-6 ticks 止损）计算的胜率。

- **止盈单数**：在 30 秒内触及 +4 ticks 的信号数量
- **止损单数**：在 30 秒内触及 -6 ticks 的信号数量
- **超时平仓**：30 秒内既未止盈也未止损的信号数量

---

## ⚙️ 配置参数

### 回测参数

可以在 `run_backtest.py` 中修改以下参数：

```python
TRACK_DURATION = 30.0  # 追踪每个信号 30 秒
REPORT_FILE_PREFIX = "Sim_Backtest"  # 报告文件名前缀
```

### 虚拟止盈止损

在 `norden_v3/backtest_analyzer.py` 中修改：

```python
self.tp_ticks = 4.0   # 虚拟止盈：+4 ticks
self.sl_ticks = -6.0  # 虚拟止损：-6 ticks
```

**注意**：这些虚拟止盈止损仅用于统计，不会影响策略的实际运行。

### 策略参数

可以在 `run_backtest.py` 中修改策略配置：

```python
self.engine = NordenMakerV3(
    maker_cfg=MakerConfig(
        base_spread_threshold=0.5,  # Spread 阈值
        min_obi_for_long=0.1,       # OBI 过滤阈值
        max_queue_size=300,         # 最大队列长度
    ),
    kalman_cfg=KalmanConfig(r_obs=1.0, q_beta=1e-8),
)
```

---

## 💡 使用技巧

### 1. 加速回放

- 推荐使用 **100x - 1000x** 的速度回放
- Python 代码经过优化，完全能处理 1000x 的 UDP 数据流
- 快速回放可以让你在短时间内测试大量历史数据

### 2. 参数调优

通过对比不同参数的回测结果，你可以：

- **提高 Spread 阈值**：减少交易次数，但可能提高每笔的 MFE
- **调整 OBI 过滤**：改变信号的进场时机
- **修改队列过滤**：影响成交概率

### 3. 数据筛选

在 Excel 或 Python 中对 CSV 数据进行进一步分析：

- 筛选特定时间段的信号
- 对比不同参数组合的表现
- 分析 MFE/MAE 的分布情况

---

## 📝 统计报告示例

```
========================================
📊 回测统计摘要 (Simulation Summary)
========================================
总信号数: 156
止盈单数 (+4.0t): 45 (28.8%)
止损单数 (-6.0t): 32 (20.5%)
超时平仓: 79 (50.6%)
平均每单盈亏: 0.85 ticks
平均 MFE (最大潜盈): 3.42 ticks
平均 MAE (最大潜亏): -2.18 ticks
========================================
```

---

## 🔍 常见问题

### Q: 为什么没有记录到信号？

**A:** 可能的原因：
1. Spread 阈值设置太高，没有信号触发
2. 过滤条件太严格（OBI、队列、BTC 风险等）
3. 数据还未开始接收，等待 ATAS 开始回放

### Q: 如何修改追踪时长？

**A:** 修改 `run_backtest.py` 中的 `TRACK_DURATION` 参数：

```python
TRACK_DURATION = 60.0  # 追踪 60 秒
```

### Q: 如何只分析特定时间段？

**A:** 在 Excel 或 Python 中打开 CSV 文件，根据 `time_str` 字段筛选。

### Q: 报告中的时间戳是什么格式？

**A:** 
- `timestamp`：Unix 毫秒时间戳
- `time_str`：可读时间格式（HH:MM:SS）

---

## 🎯 下一步

1. **分析报告**：打开生成的 CSV 文件，分析信号表现
2. **调整参数**：根据 MFE/MAE 结果调整策略参数
3. **再次回测**：用新参数重新回测，对比效果
4. **优化策略**：持续迭代，找到最佳参数组合

---

## 📚 相关文档

- **参数配置**：`norden_v3/配置参数说明.md`
- **策略说明**：`norden_v3/README.md`
- **核心代码**：
  - `norden_v3/backtest_analyzer.py`：回测分析模块
  - `run_backtest.py`：回测启动脚本

---

**最后更新**：2025-01-19  
**版本**：v3.1

