# ES 数据接收问题排查指南

## 🔍 问题现象

从调试输出可以看到：
```
[DEBUG] 事件=145,000 | ES=N/A NQ=25574.0 DOM=✗ | Fair=None Spread=Nonet | 信号数=0
```

**关键问题**：
- ❌ ES 数据未接收到（ES=N/A）
- ✅ NQ 数据正常（NQ=25574.0）
- ❌ DOM 数据缺失（DOM=✗）

---

## 🔎 可能的原因

### 1. C# 端没有发送 ES 数据

**检查点**：
- ATAS 中是否正确订阅了 ES 合约？
- C# 指标（`NFQE_Bridge_UDP`）是否正在运行？
- C# 端是否有 ES 数据的日志输出？

### 2. ES 数据的 symbol 名称不匹配

**可能的情况**：
- C# 端发送的是 `"ES "`（带空格）而不是 `"ES"`
- C# 端发送的是 `"ESM"`（带月份）而不是 `"ES"`
- C# 端发送的是 `"es"`（小写）而不是 `"ES"`

**解决方案**：
代码已经添加了大小写和空格处理，但需要检查 C# 端实际发送的 symbol 名称。

### 3. UDP 数据接收问题

**检查点**：
- UDP 端口是否正确（默认 5555）？
- 防火墙是否阻止了 UDP 数据？
- 网络是否正常？

---

## ✅ 诊断步骤

### 步骤 1：检查 C# 端配置

1. **确认 ATAS 中已订阅 ES 合约**
   - 打开 ATAS
   - 检查是否有 ES 合约的图表
   - 确认图表中有成交数据

2. **检查 C# 指标是否运行**
   - 在 ATAS 中加载 `NFQE_Bridge_UDP` 指标
   - 检查指标日志，看是否有错误

3. **检查 C# 端发送的数据**
   - 查看 C# 端日志，确认是否有发送 ES 数据
   - 检查发送的 symbol 名称是什么

### 步骤 2：检查 Python 端接收

运行回测时，观察以下输出：

1. **`[TRADE DEBUG]` 输出**：
   - 显示每次收到的成交数据
   - 显示已缓存的品种列表
   - 帮助识别实际收到的品种名称

2. **`[DEBUG]` 输出**：
   - 显示所有已接收的品种
   - 帮助识别 ES 数据是否以其他名称接收

### 步骤 3：检查数据格式

检查 C# 端发送的数据格式是否正确：
- 成交数据格式：`T,Symbol,Price,Volume,Side,Ticks`
- DOM 数据格式：`D,Symbol,Bids,Asks,Ticks`

---

## 🔧 快速修复方案

### 方案 1：检查 C# 端 symbol 名称

如果 C# 端发送的 symbol 名称不是 `"ES"`，可以：

1. **修改 Python 端代码**，支持其他 symbol 名称：
   ```python
   # 在 _handle_trade 中添加
   if sym.upper().startswith('ES'):  # 匹配 ES, ESM, ES 等
   ```

2. **或者统一 C# 端和 Python 端的 symbol 名称**

### 方案 2：添加原始数据日志

在 `_handle_trade` 方法开始时，打印原始事件数据：
```python
if self.event_count <= 20:  # 前20个事件
    print(f"[RAW EVENT] {event}", flush=True)
```

---

## 📊 预期输出示例

### 正常情况（有 ES 数据）
```
[TRADE DEBUG] 收到: ES @ 6849.25 | 已缓存品种: ['ES', 'NQ', 'YM']
[DEBUG] 事件=5,000 | ES=6849.25 NQ=25574.0 DOM=✓ | Fair=6849.30 Spread=+0.20t | 已接收品种: ['ES', 'NQ', 'YM'] | 信号数=0
```

### 异常情况（无 ES 数据）
```
[TRADE DEBUG] 收到: NQ @ 25574.0 | 已缓存品种: ['NQ']
[DEBUG] 事件=5,000 | ES=N/A NQ=25574.0 DOM=✗ | Fair=None Spread=Nonet | 已接收品种: ['NQ'] | 信号数=0
```

---

## 💡 下一步操作

1. **运行回测**，查看新的调试输出
2. **检查 `[TRADE DEBUG]` 输出**，看实际收到了哪些品种
3. **检查 C# 端配置**，确认 ES 数据是否正确发送
4. **根据调试输出**，调整代码以匹配实际的 symbol 名称

---

**最后更新**：2025-01-19

