# 端口占用问题排查指南

## ❌ 错误信息

```
OSError: [WinError 10048] 通常每个套接字地址(协议/网络地址/端口)只允许使用一次。
```

## 🔍 问题原因

UDP 端口 5555 已被占用，可能的原因：

1. **之前的程序还在运行**
   - 之前运行的回测程序、仪表盘程序等没有完全关闭
   - Python 进程还在后台运行

2. **其他程序正在使用**
   - 数据记录程序 (`data_recorder_async_pandas.py`)
   - 仪表盘程序 (`run_dashboard_gui.py`)
   - 其他回测程序 (`run_backtest.py`, `run_backtest_suite.py`)

3. **系统进程占用**
   - 系统服务或防火墙占用了端口

---

## ✅ 解决方案

### 方案 1：关闭其他程序（推荐）

1. **检查任务管理器**
   - 按 `Ctrl + Shift + Esc` 打开任务管理器
   - 查找所有 Python 进程
   - 结束所有相关的 Python 进程

2. **关闭命令行窗口**
   - 关闭所有运行回测/仪表盘程序的命令行窗口
   - 确保所有相关程序都已停止

3. **等待几秒后重试**
   - 程序关闭后，端口释放可能需要几秒钟
   - 等待 3-5 秒后重新运行

### 方案 2：检查端口占用

在 PowerShell 或 CMD 中运行：

```powershell
netstat -ano | findstr 5555
```

这会显示占用端口 5555 的进程。然后：

```powershell
taskkill /PID <进程ID> /F
```

### 方案 3：重启 Python 环境

如果问题持续：

1. 关闭所有 Python 程序
2. 重启 IDE（如 VS Code、PyCharm）
3. 重新运行程序

### 方案 4：修改端口（不推荐）

如果确实需要同时运行多个程序，可以修改端口：

1. 修改 `dom_data_feed.py` 中的 `UDP_PORT`
2. 同时修改 C# 端的发送端口
3. 确保两端端口一致

---

## 🔧 预防措施

### 1. 确保程序正确关闭

程序应该能够正确关闭 UDP 监听器：

```python
try:
    suite.run(duration_seconds=60.0)
except KeyboardInterrupt:
    print("\n⚠️  回测被中断")
finally:
    suite.listener.stop()  # 确保监听器被关闭
```

### 2. 一次只运行一个程序

- 不要同时运行多个使用相同 UDP 端口的程序
- 关闭一个程序后再启动另一个

### 3. 检查程序是否还在运行

启动新程序前，检查：
- 任务管理器中是否有相关的 Python 进程
- 命令行窗口是否都已关闭

---

## 📝 常见场景

### 场景 1：刚关闭程序就启动新程序

**问题**：程序关闭后立即启动新程序，端口还未释放

**解决**：等待 3-5 秒后再启动新程序

### 场景 2：多个程序同时运行

**问题**：同时运行了 `run_backtest.py` 和 `run_backtest_suite_parallel.py`

**解决**：只运行一个程序，关闭其他程序

### 场景 3：程序异常退出

**问题**：程序崩溃或被强制关闭，UDP 监听器没有正确关闭

**解决**：
1. 检查任务管理器，结束所有 Python 进程
2. 等待几秒后重试
3. 如果问题持续，重启电脑

---

## 🆘 如果问题仍然存在

1. **检查防火墙/杀毒软件**
   - 可能拦截了 UDP 端口
   - 暂时关闭防火墙测试

2. **检查系统服务**
   - 某些系统服务可能占用端口
   - 使用 `netstat -ano | findstr 5555` 查看

3. **重启电脑**
   - 最后的解决方案
   - 可以释放所有占用的端口

---

## 📞 技术支持

如果问题仍然无法解决，请提供以下信息：

1. 错误信息（完整堆栈）
2. 运行的程序名称
3. 是否有其他相关程序在运行
4. `netstat -ano | findstr 5555` 的输出

---

**最后更新**：2025-01-19

